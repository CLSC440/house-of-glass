<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Of Glass | Gallery</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg?v=2">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="theme-color" content="#121926">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brandBlue: '#121926',
                        brandGold: '#D4AF37',
                        darkBg: '#030712',
                        darkCard: '#111827'
                    },
                    fontFamily: {
                        arabic: ['Almarai', 'Cairo', 'sans-serif'],
                    }
                }
            }
        }

        // --- Smart Theme Logic ---
        function applySmartTheme() {
            const isAutoEnabled = localStorage.getItem('autoThemeEnabled') !== 'false'; // Default to true
            const manualTheme = localStorage.getItem('darkMode');
            const overrideTime = localStorage.getItem('themeOverrideTime');
            const now = Date.now();
            
            if (!isAutoEnabled) {
                // If auto is disabled, strictly follow manual choice or system preference
                if (manualTheme === 'true') document.documentElement.classList.add('dark');
                else if (manualTheme === 'false') document.documentElement.classList.remove('dark');
                return;
            }

            // Return to Auto mode after 10 minutes (600,000ms)
            if (overrideTime && (now - overrideTime > 600000)) {
                localStorage.removeItem('darkMode');
                localStorage.removeItem('themeOverrideTime');
            } else if (manualTheme !== null) {
                if (manualTheme === 'true') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                return;
            }

            const hour = new Date().getHours();
            if (hour < 6 || hour >= 18) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applySmartTheme();
    </script>
    <style>
        * {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #C19B4E rgba(193, 155, 78, 0.05);
        }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Professional Scrollbar Styling - Global */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(193, 155, 78, 0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #D4AF37, #B08D2C);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #E5C354, #D4AF37);
        }
        .dark ::-webkit-scrollbar-track {
            background: rgba(193, 155, 78, 0.08);
        }
        
        /* Animations */
        .reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s ease-out;
        }
        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        #swipeArea {
            touch-action: pan-y;
            user-select: none;
        }
        
        #mainDetailImg {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #C19B4E33;
            border-radius: 10px;
        }
        /* Dark toggle: fully circular by default, expands to pill on hover or click */
        #darkToggle {
            width: 3rem; /* default resting width */
            height: 3rem;
            padding: 0 0.35rem;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #darkToggle.expanded, #darkToggle:hover {
            width: 9rem !important; /* ~144px */
        }
        #darkTextDay, #darkTextNight {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            white-space: nowrap;
        }
        /* Reveal active label when expanded */
        #darkToggle.expanded #darkTextDay, 
        #darkToggle:hover #darkTextDay {
            opacity: 1;
            visibility: visible;
        }
        .dark #darkToggle.expanded #darkTextNight,
        .dark #darkToggle:hover #darkTextNight {
            opacity: 1;
            visibility: visible;
        }
        /* Knob logic */
        #darkToggle .knob {
            width: 2.25rem;
            height: 2.25rem;
            left: 0.375rem;
            top: 0.375rem;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #headerUserProfile[data-mode="guest"] {
            min-width: 0;
        }
        #headerUserProfile[data-mode="guest"] .profile-text {
            white-space: nowrap;
        }
        .dark #darkToggle.expanded .knob,
        .dark #darkToggle:hover .knob {
            transform: translateX(6rem);
        }

        /* Mobile: keep toggle compact, hide labels */
        @media (max-width: 768px) {
            #darkToggle,
            #darkToggle.expanded,
            #darkToggle:hover {
                width: 2.55rem !important;
                height: 2.55rem;
                padding: 0 0.25rem;
            }
            #darkTextDay,
            #darkTextNight {
                display: none !important;
            }
            #darkToggle .knob {
                width: 1.9rem;
                height: 1.9rem;
                left: 0.33rem;
                top: 0.33rem;
            }
            .dark #darkToggle.expanded .knob,
            .dark #darkToggle:hover .knob {
                transform: translateX(0);
            }

            #headerUserProfile {
                min-width: auto !important;
                max-width: 220px;
                padding: 0.45rem 0.9rem;
                gap: 0.5rem;
            }
            #headerUserProfile .profile-text {
                max-width: 120px;
            }
            #headerUserProfile[data-mode="guest"] {
                max-width: 155px;
                padding: 0.35rem 0.65rem;
            }
            #headerUserProfile[data-mode="guest"] .profile-text {
                max-width: 80px;
            }
        }

        /* Ultra-Realistic Warm Glass & Sunlight Effect */
        @keyframes rim-glow {
            0%, 100% { 
                filter: 
                    drop-shadow(0 0 1px rgba(255, 236, 180, 0.8)) 
                    drop-shadow(0 0 8px rgba(212, 175, 55, 0.3))
                    brightness(1.15) contrast(1.1); 
            }
            50% { 
                filter: 
                    drop-shadow(0 0 2px rgba(255, 245, 220, 1)) 
                    drop-shadow(0 0 12px rgba(212, 175, 55, 0.5))
                    brightness(1.3) contrast(1.15); 
            }
        }
        @keyframes sparkle {
            0%, 100% { opacity: 0.4; transform: scale(0.8) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.1) rotate(15deg); }
        }
        .shine-effect {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        .dark .shine-effect img {
            animation: rim-glow 6s ease-in-out infinite;
            transition: all 0.5s ease;
            image-rendering: -webkit-optimize-contrast;
        }

        /* Cinematic Scrolling Product Title */
        .title-container {
            overflow: hidden;
            width: 100%;
            white-space: nowrap;
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }
        
        .title-slide {
            display: block;
            width: max-content;
        }

        .group:hover .title-slide {
            animation: marqueeTitle 8s linear infinite;
            padding-left: 30px;
        }

        @keyframes marqueeTitle {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* Floating Notification Bell Animations */
        @keyframes notifBellShake {
            0%, 100% { transform: rotate(0deg); }
            10% { transform: rotate(14deg); }
            20% { transform: rotate(-12deg); }
            30% { transform: rotate(10deg); }
            40% { transform: rotate(-8deg); }
            50% { transform: rotate(6deg); }
            60% { transform: rotate(-4deg); }
            70% { transform: rotate(2deg); }
            80% { transform: rotate(0deg); }
        }
        @keyframes notifBellFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        @keyframes notifPulseRing {
            0% { transform: scale(1); opacity: 0.6; }
            100% { transform: scale(1.8); opacity: 0; }
        }
        #notifFloatingBtn.has-unread {
            animation: notifBellFloat 2.5s ease-in-out infinite;
        }
        #notifFloatingBtn.has-unread svg {
            animation: notifBellShake 3s ease-in-out infinite;
        }
        #notifFloatingBtn.has-unread::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: inherit;
            animation: notifPulseRing 2s ease-out infinite;
            z-index: -1;
        }
        #notifDesktopBtn.has-unread svg {
            animation: notifBellShake 3s ease-in-out infinite;
        }
        
        .group:hover .title-container {
            mask-image: none;
            -webkit-mask-image: none;
        }

        /* Horizontal Category Scrolling */
        .category-row-wrapper {
            position: relative;
            margin-bottom: 4rem;
        }
        .category-row-container {
            display: flex;
            overflow-x: auto;
            /* scroll-behavior: smooth; Removed to prevent stuck feeling during manual scroll */
            gap: 1.5rem;
            padding: 1rem 1px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .category-row-container::-webkit-scrollbar {
            display: none;
        }
        .category-card {
            flex: 0 0 240px;
        }
        @media (min-width: 768px) {
            .category-card {
                flex: 0 0 320px;
            }
        }

        /* Quick Edit Styles */
        .image-row:hover .delete-img { opacity: 1; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #D4AF37; border-radius: 10px; }
        .scroll-arrow {
            position: absolute;
            top: 55%;
            transform: translateY(-50%);
            z-index: 30;
            width: 3rem;
            height: 3rem;
            background: white;
            color: #121926;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            opacity: 0;
            pointer-events: none;
        }
        .dark .scroll-arrow {
            background: #111827;
            color: white;
        }
        .category-row-wrapper:hover .scroll-arrow {
            opacity: 1;
            pointer-events: auto;
        }
        .scroll-arrow:hover {
            background: #D4AF37;
            color: white;
            scale: 1.1;
            box-shadow: 0 15px 30px rgba(212, 175, 55, 0.3);
        }
        .scroll-arrow-left { left: -1.5rem; }
        .scroll-arrow-right { right: -1.5rem; }
        
        @media (max-width: 1024px) {
            .scroll-arrow { display: none; }
        }
    </style>
</head>
<body class="bg-white dark:bg-darkBg font-sans transition-colors duration-300">

    <!-- Header -->
    <header class="bg-white/80 dark:bg-brandBlue/80 backdrop-blur-xl sticky top-0 z-50 border-b border-brandGold/20 transition-all duration-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 md:h-24 flex items-center justify-between">
            <!-- Left: Toggle Sidebar (Mobile flex-1 to push logo to center) -->
            <div class="flex-1 md:flex-none">
                <button onclick="toggleSidebar()" class="p-2 text-brandBlue dark:text-brandGold hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>

            <!-- Middle: Logo (Centered on mobile via flex-none and justify-center container) -->
            <div class="flex-none md:flex-1 flex justify-center md:justify-start md:ml-4">
                <a href="index.html" class="flex items-center group">
                    <div class="shine-effect">
                        <img src="logo.png" alt="Logo" class="h-24 md:h-32 w-auto transition-all group-hover:scale-105 relative z-10">
                    </div>
                    <div class="ml-3 hidden lg:flex flex-col justify-center leading-none">
                        <span class="text-xl md:text-2xl font-bold text-brandBlue dark:text-brandGold tracking-[-0.03em] font-sans">House Of Glass</span>
                        <span class="text-[9px] md:text-[11px] font-black tracking-[0.25em] text-brandGold dark:text-slate-200 uppercase mt-1.5 opacity-90">Al Ashour Ades</span>
                    </div>
                </a>
            </div>
            
            <!-- Right: Controls -->
            <div class="flex-1 md:flex-none flex items-center justify-end space-x-3 md:space-x-6">
                 <!-- Shopping Cart Button -->
                 <button onclick="openCart()" class="relative p-2 text-brandBlue dark:text-brandGold hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-7 md:w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center opacity-0 transform scale-0 transition-all duration-300">0</span>
                </button>

                 <!-- Wholesale Cart Button (hidden for CST. Retail) -->
                 <button id="wholesaleCartBtn" onclick="openWholesaleCart()" class="relative p-2 text-brandGold hover:bg-brandGold/10 rounded-lg transition-colors group hidden" title="Wholesale Order">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-7 md:w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <span id="wholesaleCartCount" class="absolute -top-1 -right-1 bg-brandGold text-brandBlue text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center opacity-0 transform scale-0 transition-all duration-300">0</span>
                </button>

                <!-- User Profile Card (Top Bar) -->
                <div id="headerUserProfile" class="hidden items-center justify-between space-x-3 md:space-x-4 px-4 py-2 md:px-5 md:py-2.5 bg-gray-50 dark:bg-gray-800 rounded-full border border-gray-100 dark:border-gray-700 shadow-[0_12px_30px_rgba(32,41,61,0.15)] min-w-[190px] md:min-w-[220px] w-auto">
                    <!-- Will be populated by JS -->
                </div>
                
                <nav id="headerNav" class="hidden md:flex items-center space-x-6">
                    <a href="index.html" class="text-brandBlue dark:text-white border-b-2 border-brandGold px-1 py-1 text-sm font-bold" data-i18n="home">Home</a>
                    <!-- Dynamic button injected by JS -->
                </nav>
                <!-- Notifications Bell (Desktop - next to nav) -->
                <button id="notifDesktopBtn" onclick="window.toggleNotifications()" class="hidden relative p-2 text-brandBlue dark:text-brandGold hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors" title="Notifications">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                    <span id="notifDesktopBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold min-w-[18px] h-[18px] px-1 rounded-full flex items-center justify-center opacity-0 transform scale-0 transition-all duration-300">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar / Drawer -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-[60] opacity-0 pointer-events-none transition-opacity duration-300" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="fixed top-0 left-0 w-72 h-full bg-white dark:bg-darkCard z-[70] -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
        <div id="sidebarHeader" class="p-5 border-b dark:border-gray-700 flex justify-between items-center">
            <h2 class="text-xl font-bold text-brandBlue dark:text-brandGold italic" data-i18n="categories">Categories</h2>
            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-brandBlue dark:hover:text-white text-xl font-bold">✕</button>
        </div>
        <div id="categoryList" class="flex-grow overflow-y-auto py-4">
            <!-- Categories will be injected here -->
        </div>
        <div class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
            <a href="login.html" class="block text-center bg-brandBlue text-white py-3 rounded-xl font-bold border border-brandGold hover:bg-opacity-90" data-i18n="admin_dashboard">Admin Dashboard</a>
        </div>
        <div class="px-6 py-5 border-t border-gray-100 dark:border-gray-800 md:hidden">
            <div class="h-px w-full bg-gradient-to-r from-transparent via-brandGold to-transparent opacity-70 mb-4"></div>
            <div class="flex items-center justify-between text-gray-400 dark:text-gray-500">
                <button id="sidebarPhone" type="button" onclick="openContactPicker()" class="p-2 hover:text-brandGold transition-colors" title="Contact">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21L8.965 10.5a11.042 11.042 0 005.516 5.516l1.113-2.33a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                </button>
                <a id="sidebarWhatsapp" href="#" class="p-2 hover:text-brandGold transition-colors" title="WhatsApp" target="_blank" rel="noopener">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M20.52 3.48A11.82 11.82 0 0012.04 0C5.49 0 .15 5.33.15 11.89c0 2.1.55 4.14 1.59 5.95L0 24l6.32-1.65a11.9 11.9 0 005.72 1.45h.01c6.55 0 11.89-5.34 11.89-11.89a11.82 11.82 0 00-3.39-8.43z" />
                        <path d="M17.47 14.38c-.3-.15-1.76-.87-2.03-.97-.27-.1-.47-.15-.67.15-.2.3-.77.96-.94 1.16-.17.2-.35.22-.64.07-.3-.15-1.25-.46-2.39-1.48-.88-.79-1.48-1.76-1.65-2.06-.17-.3-.02-.46.13-.6.13-.13.3-.35.44-.52.15-.17.2-.3.3-.5.1-.2.05-.37-.02-.52-.07-.15-.67-1.61-.92-2.21-.24-.58-.49-.5-.67-.5h-.58c-.2 0-.52.07-.79.37-.27.3-1.04 1.02-1.04 2.48 0 1.46 1.06 2.88 1.21 3.08.15.2 2.1 3.2 5.08 4.49.71.31 1.26.49 1.7.63.71.23 1.36.2 1.87.12.57-.09 1.76-.72 2.01-1.41.25-.69.25-1.29.17-1.41-.07-.13-.27-.2-.57-.35z" />
                    </svg>
                </a>
                <a id="sidebarFacebook" href="#" class="p-2 hover:text-brandGold transition-colors" title="Facebook" target="_blank" rel="noopener">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12S0 5.446 0 12.073c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                    </svg>
                </a>
                <a id="sidebarMaps" href="#" class="p-2 hover:text-brandGold transition-colors" title="Location" target="_blank" rel="noopener">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z" />
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <!-- Hero -->
    <section class="bg-white dark:bg-brandBlue py-16 md:py-32 text-center relative overflow-hidden transition-all duration-1000">
        <!-- Subtle backround effect -->
        <div class="absolute inset-0 opacity-10 dark:opacity-20 pointer-events-none">
            <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_50%_50%,_rgba(0,0,0,0.1),transparent_70%)] dark:bg-[radial-gradient(circle_at_50%_50%,_rgba(193,155,78,0.15),transparent_70%)]"></div>
        </div>
        
        <div class="relative z-10 px-4 reveal active">
            <h2 class="text-3xl md:text-7xl font-black mb-4 text-brandGold tracking-tighter uppercase drop-shadow-sm dark:drop-shadow-[0_0_20px_rgba(193,155,78,0.4)]">House Of Glass</h2>
            
            <div class="flex flex-col items-center justify-center mb-12 md:mb-16">
                <p class="text-[8px] md:text-xs tracking-[0.4em] md:tracking-[0.6em] uppercase text-slate-400 dark:text-white/40 font-bold mb-6 md:mb-10 transition-all hover:opacity-60 cursor-default" data-i18n="showroom">Showroom for Home Glassware</p>
                
                <div class="flex items-center justify-center w-full max-w-3xl mx-auto group">
                    <div class="flex-grow h-[1px] bg-gradient-to-l from-brandGold via-brandGold/40 to-transparent transition-all duration-1000 dark:group-hover:from-white"></div>
                    <p class="text-3xl md:text-7xl font-black text-[#163159] dark:text-slate-100 font-arabic px-6 md:px-16 whitespace-nowrap leading-none transition-all duration-700 hover:scale-105" dir="rtl" style="text-shadow: 0 10px 30px rgba(22,49,89,0.1);">
                        ال عاشور عدس
                    </p>
                    <div class="flex-grow h-[1px] bg-gradient-to-r from-brandGold via-brandGold/40 to-transparent transition-all duration-1000 dark:group-hover:from-white"></div>
                </div>
            </div>
            
            <p class="text-sm md:text-2xl text-slate-500 dark:text-white/60 max-w-2xl mx-auto font-light tracking-widest italic font-serif mt-4 md:mt-8" data-i18n="excellence">"Excellence in every reflection."</p>
        </div>
    </section>

    <!-- Search Section -->
    <div class="max-w-7xl mx-auto px-4 -mt-8 md:-mt-10 relative z-20">
        <div class="bg-white dark:bg-darkCard/90 backdrop-blur-2xl rounded-2xl shadow-[0_20px_40px_rgba(0,0,0,0.06)] p-4 md:p-6 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-6 border border-brandGold/20">
            <div class="flex-grow relative">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="searchInput" placeholder="Search by name or category..." data-i18n-placeholder="search_placeholder" class="w-full pl-11 md:pl-12 pr-4 py-3 md:py-4 rounded-xl bg-gray-100/50 dark:bg-gray-800/50 dark:text-slate-200 border-none focus:ring-2 focus:ring-brandGold outline-none transition-all text-sm md:text-base">
            </div>
            
            <!-- Category Dropdown -->
            <div class="relative group/cat">
                <button onclick="toggleCatDropdown()" class="w-full h-full min-w-[160px] flex items-center justify-between px-5 md:px-6 bg-brandGold/5 text-brandGold rounded-xl font-bold py-3 md:py-4 hover:bg-brandGold/10 transition-all text-sm md:text-base border border-brandGold/10">
                    <span id="activeFilterDisplay" data-i18n="category_all">Category: All</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2 transition-transform group-hover/cat:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div id="catDropdown" class="absolute right-0 top-full mt-2 w-full min-w-[200px] bg-white dark:bg-darkCard rounded-xl shadow-2xl border border-gray-100 dark:border-gray-700 py-2 hidden z-[60]">
                    <!-- Dropdown items will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Grid -->
    <main class="max-w-7xl mx-auto px-4 md:px-6 py-16 md:py-24 min-h-[60vh]">
        <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-10">
            <!-- Loading Skeleton -->
            <div class="loading-skeleton col-span-full flex flex-col items-center justify-center py-20">
                <img src="logo.png" class="h-20 md:h-24 w-auto mb-6 animate-pulse opacity-60" alt="Loading...">
                <div class="flex gap-2">
                    <div class="w-2 h-2 bg-brandGold rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-2 h-2 bg-brandGold rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-brandGold rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
                <p class="mt-4 text-xs text-gray-400 dark:text-gray-500 uppercase tracking-widest" data-i18n="loading">Loading Products...</p>
            </div>
        </div>
    </main>

    <!-- Floating Contact (WhatsApp) -->
    <div id="floatingFabGroup" class="fixed bottom-6 right-6 z-[80] flex flex-col items-center gap-3 translate-y-20 opacity-0 invisible transition-all duration-500">
        <!-- Notification Bell FAB (Mobile only, above WhatsApp) -->
        <button id="notifFloatingBtn" onclick="window.toggleNotifications()" class="hidden w-12 h-12 bg-brandBlue dark:bg-brandGold rounded-full shadow-2xl shadow-brandBlue/40 dark:shadow-brandGold/40 items-center justify-center transition-all duration-300 hover:scale-110 active:scale-95 md:hidden" title="Notifications">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-brandGold dark:text-brandBlue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span id="notifFloatingBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold min-w-[20px] h-5 px-1 rounded-full flex items-center justify-center opacity-0 transform scale-0 transition-all duration-300 shadow-lg">0</span>
        </button>
        <!-- WhatsApp Button -->
        <a id="floatingWhatsapp" href="https://wa.me/201026600350" target="blank" class="bg-[#25D366] text-white p-3 rounded-full shadow-2xl hover:scale-110 transition-all flex items-center group">
            <svg viewBox="0 0 24 24" class="h-6 w-6" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
            <span class="max-w-0 overflow-hidden group-hover:max-w-xs group-hover:ml-2 transition-all duration-300 font-bold whitespace-nowrap text-sm">Contact Us</span>
        </a>
    </div>

    <footer class="bg-white dark:bg-darkCard border-t border-brandGold/20 pt-24 pb-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <div class="mb-16 flex flex-col items-center">
                <div class="shine-effect">
                    <img src="logo.png" alt="Logo" class="h-32 md:h-48 transition-all cursor-pointer relative z-10" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                </div>
                
                <p class="text-[10px] md:text-xs font-black tracking-[0.4em] uppercase opacity-40 dark:text-brandGold dark:opacity-80 mb-8" data-i18n="powered_by">Powered By</p>

                <div class="flex items-center justify-center space-x-6 md:space-x-8 mb-6">
                    <div class="h-px w-6 md:w-8 bg-gradient-to-l from-brandGold/40 to-transparent"></div>
                    <p class="text-2xl md:text-3xl font-black text-brandBlue dark:text-brandGold font-arabic tracking-tight" dir="rtl">ال عاشور عدس</p>
                    <div class="h-px w-6 md:w-8 bg-gradient-to-r from-brandGold/40 to-transparent"></div>
                </div>
                
                <p class="text-brandBlue dark:text-brandGold/80 text-[10px] md:text-xs font-black tracking-[0.3em] uppercase opacity-70 mb-10" data-i18n="premium_home_glassware">Al Ashour Ades Showroom</p>

                <!-- Social Links -->
                <div class="flex items-center justify-center space-x-8 mb-12">
                    <button onclick="openContactPicker()" class="text-gray-400 hover:text-brandGold transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                    </button>
                    <a id="footerWhatsapp" href="https://wa.me/201026600350" target="_blank" class="text-gray-400 hover:text-[#25D366] transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                    </a>
                    <a id="footerFacebook" href="#" target="_blank" class="text-gray-400 hover:text-brandGold transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                    </a>
                    <a id="footerMaps" href="#" target="_blank" class="text-gray-400 hover:text-brandGold transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>
                    </a>
                </div>
            </div>
            
            <div class="border-t border-gray-100 dark:border-gray-800 pt-8 flex flex-col md:flex-row justify-between items-center text-gray-400 text-[10px] md:text-xs">
                <p class="mb-4 md:mb-0">© 2026 Al Ashour Ades. All rights reserved.</p>
                <div class="flex space-x-6">
                    <span>Sat - Thu: 10AM - 10PM</span>
                    <span class="text-brandGold font-bold tracking-widest uppercase" data-i18n="premium_home_glassware">Premium Home Glassware</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- PRODUCT DETAIL MODAL -->
    <div id="detailModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-80" onclick="closeDetails()"></div>
        <div class="modal-container bg-white dark:bg-darkCard w-[92%] md:max-w-4xl mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden flex flex-col md:flex-row max-h-[90vh] md:max-h-[80vh] transition-all duration-300 transform relative">
            <!-- Global close button for the card -->
            <button onclick="closeDetails()" class="absolute top-3 right-3 md:top-5 md:right-5 z-[70] bg-white/90 dark:bg-black/50 backdrop-blur-md text-gray-800 dark:text-white w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center shadow-xl hover:bg-brandGold hover:text-white dark:hover:bg-brandGold transition-all active:scale-95 border border-black/5 dark:border-white/10">
                <svg class="w-5 h-5 md:w-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- Image Section -->
            <div class="w-full md:w-1/2 bg-gray-100 dark:bg-gray-800 relative group overflow-hidden">
                <div id="swipeArea" class="flex items-center justify-center p-8 md:p-24 touch-pan-y h-[40vh] md:h-full relative">
                    <img id="mainDetailImg" src="" class="max-w-full max-h-full object-contain rounded-xl select-none transition-transform duration-300">
                    <!-- Out of Stock Overlay -->
                    <div id="outOfStockOverlay" class="absolute inset-0 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-30">
                        <div class="bg-black/40 text-white px-5 py-3 rounded-2xl font-black uppercase tracking-widest shadow-2xl flex flex-col items-center border-2 border-brandGold/60">
                            <span class="text-lg md:text-2xl leading-none mb-1">Out of stock</span>
                            <span class="text-[10px] md:text-xs leading-none text-brandGold font-bold font-arabic capitalize">غير متاح حاليا!</span>
                        </div>
                    </div>
                </div>
                <!-- Floating Thumbnails Bar -->
                <div id="thumbnailBar" class="absolute left-3 top-1/2 -translate-y-1/2 w-14 h-auto max-h-[75%] flex flex-col space-y-2 p-1 overflow-y-auto overflow-x-hidden md:left-1/2 md:top-auto md:bottom-4 md:-translate-x-1/2 md:translate-y-0 md:w-max md:max-w-[95%] md:h-20 md:flex-row md:space-x-4 md:px-4 md:overflow-x-auto md:overflow-y-hidden md:items-center md:justify-start bg-transparent md:bg-white/40 md:dark:bg-black/40 backdrop-blur-xl rounded-2xl border border-white/30 dark:border-white/10 z-20 shadow-2xl transition-all duration-300 hide-scroll">
                    <!-- Thumbnails will go here -->
                </div>
            </div>

            <!-- Content Section -->
            <div class="w-full md:w-1/2 p-5 md:p-8 flex flex-col justify-between overflow-y-auto">
                <div class="space-y-4 md:space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 id="detailTitle" class="text-lg md:text-2xl font-black text-brandBlue dark:text-slate-100 uppercase italic tracking-tighter flex-1"></h2>
                        <!-- Favorite button next to title -->
                        <button id="detailFavBtn" class="hidden p-2 rounded-full hover:scale-110 active:scale-95 transition-all text-gray-400" onclick="toggleFavorite(event, currentProduct?.id).then(()=>updateModalFavBtn())">
                            <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                    </div>
                    <div class="w-12 h-1 bg-brandGold rounded-full"></div>
                    <p id="detailDesc" class="text-xs md:text-sm text-gray-600 dark:text-gray-300 leading-relaxed font-medium"></p>
                    <div id="detailVariants" class="mt-4 hidden animate-fade-in-up">
                        <!-- Variants injected via JS -->
                    </div>
                    
                    <!-- Live Price Section -->
                    <div id="detailPriceSection" class="hidden mt-4 p-3 rounded-xl bg-gray-50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="flex flex-col">
                                    <span class="text-[8px] text-gray-400 uppercase font-bold tracking-wider">Pack. Price<br>سعر العبوة</span>
                                    <span id="detailNetPrice" class="text-lg font-black text-green-600">--</span>
                                </div>
                                <span class="text-gray-300 dark:text-gray-600 text-lg font-light">|</span>
                                <div class="flex flex-col">
                                    <span class="text-[8px] text-gray-400 uppercase font-bold tracking-wider">Discount</span>
                                    <span id="detailDiscount" class="text-lg font-black text-red-500">--</span>
                                </div>
                            </div>
                            <div id="detailRetailPriceWrap" class="flex flex-col text-right">
                                <span class="text-[8px] text-gray-400 uppercase font-bold tracking-wider">Retail<br>العبوة</span>
                                <span id="detailRetailPrice" class="text-sm font-bold text-gray-400 line-through">--</span>
                            </div>
                            <div class="flex flex-col text-right">
                                <span class="text-[8px] text-gray-400 uppercase font-bold tracking-wider">Wholesale<br>الكرتونة</span>
                                <span id="detailWholesalePrice" class="text-sm font-bold text-brandGold">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Add to Wholesale Order Button -->
                    <div id="detailWholesaleBtn" class="hidden mt-3">
                        <p class="text-[9px] text-brandGold uppercase font-bold tracking-widest mb-1.5 text-center">اضف كرتونة جملة &nbsp;•&nbsp; Add Carton</p>
                        <div class="flex items-stretch gap-2">
                            <div class="flex items-center bg-gray-100 dark:bg-gray-800 border-2 border-brandGold/30 rounded-xl overflow-hidden">
                                <button onclick="var i=document.getElementById('wholesaleQtyInput'); var v=parseInt(i.value)||1; if(v>1){i.value=v-1;}" class="w-9 h-full flex items-center justify-center text-brandGold hover:bg-brandGold/10 font-black text-lg transition-colors">−</button>
                                <input id="wholesaleQtyInput" type="number" value="1" min="1" class="w-12 text-center bg-transparent text-brandGold font-black text-sm border-x border-brandGold/20 py-3 focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                                <button onclick="var i=document.getElementById('wholesaleQtyInput'); var v=parseInt(i.value)||1; i.value=v+1;" class="w-9 h-full flex items-center justify-center text-brandGold hover:bg-brandGold/10 font-black text-lg transition-colors">+</button>
                            </div>
                            <button id="wholesaleOrderBtn" class="flex-1 py-3 bg-brandGold/10 text-brandGold border-2 border-brandGold/30 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-brandGold hover:text-white transition-all flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                                <span>Add to Cart | اضف كرتونة</span>
                            </button>
                        </div>
                    </div>

                    <!-- Add to Cart Button (for CST. Retail & CST. Wholesale) -->
                    <div id="detailRetailCartBtn" class="hidden mt-3">
                        <p class="text-[9px] text-green-500 uppercase font-bold tracking-widest mb-1.5 text-center">اضف عبوة شيالة | علبة &nbsp;•&nbsp; Add Pack / Box</p>
                        <div class="flex items-stretch gap-2">
                            <div class="flex items-center bg-gray-100 dark:bg-gray-800 border-2 border-green-500/30 rounded-xl overflow-hidden">
                                <button onclick="var i=document.getElementById('retailQtyInput'); var v=parseInt(i.value)||1; if(v>1){i.value=v-1;}" class="w-9 h-full flex items-center justify-center text-green-600 hover:bg-green-500/10 font-black text-lg transition-colors">−</button>
                                <input id="retailQtyInput" type="number" value="1" min="1" class="w-12 text-center bg-transparent text-green-600 font-black text-sm border-x border-green-500/20 py-3 focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                                <button onclick="var i=document.getElementById('retailQtyInput'); var v=parseInt(i.value)||1; i.value=v+1;" class="w-9 h-full flex items-center justify-center text-green-600 hover:bg-green-500/10 font-black text-lg transition-colors">+</button>
                            </div>
                            <button id="retailCartOrderBtn" class="flex-1 py-3 bg-green-600/10 text-green-500 border-2 border-green-500/30 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-green-600 hover:text-white active:scale-95 active:brightness-110 transition-all flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                <span>ADD TO CART | اضف للعربة</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-6 md:mt-10">
                    <a id="enquiryBtn" href="#" target="_blank" class="flex items-center justify-center space-x-2 w-full bg-[#25D366] text-white py-2.5 md:py-4 rounded-xl font-bold hover:bg-opacity-90 transition-all shadow-lg text-xs md:text-base">
                        <svg viewBox="0 0 24 24" class="h-5 w-5 md:h-6 md:w-6" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                        <span>Ask on WhatsApp</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- User Settings Modal -->
    <div id="userSettingsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100] transition-all duration-300">
        <div class="absolute w-full h-full bg-black/60 backdrop-blur-sm" onclick="closeUserSettingsModal()"></div>
        <div class="bg-white dark:bg-darkCard w-11/12 max-w-md mx-auto rounded-3xl shadow-2xl z-[110] overflow-hidden relative border border-gray-100 dark:border-gray-800">
            <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50">
                <h2 class="text-xl font-black text-brandBlue dark:text-brandGold uppercase italic tracking-tight" data-i18n="settings_title">Account Settings</h2>
                <button onclick="closeUserSettingsModal()" class="text-gray-400 hover:text-red-500 transition-colors bg-white dark:bg-gray-700 p-2 rounded-full shadow-sm">✕</button>
            </div>
            
            <form id="userSettingsForm" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto custom-scroll">
                <!-- Profile Image Section -->
                <div class="flex flex-col items-center mb-6">
                    <div class="relative group">
                        <div id="settingsPhotoPreview" class="w-24 h-24 rounded-full bg-brandGold/10 border-4 border-white dark:border-gray-800 shadow-xl overflow-hidden flex items-center justify-center text-4xl text-brandGold font-black uppercase">
                            ?
                        </div>
                        <label class="absolute bottom-0 right-0 bg-brandBlue text-white p-2 rounded-full shadow-lg cursor-pointer hover:scale-110 transition-transform border-2 border-white dark:border-gray-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <input type="file" id="userPhotoInput" class="hidden" accept="image/*" onchange="handleUserPhoto(this)">
                        </label>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 uppercase tracking-widest font-bold" data-i18n="change_profile_photo">Change Profile Photo</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1" data-i18n="settings_username">Username</label>
                        <input type="text" id="settingsUsername" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none dark:text-white">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1" data-i18n="settings_first_name">First Name</label>
                            <input type="text" id="settingsFirstName" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none dark:text-white">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1" data-i18n="settings_last_name">Last Name</label>
                            <input type="text" id="settingsLastName" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none dark:text-white">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1" data-i18n="settings_email">Email Address</label>
                        <input type="email" id="settingsEmail" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm text-gray-500 dark:text-gray-400 outline-none" readonly>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1" data-i18n="settings_phone">Phone Number</label>
                        <div class="flex group">
                            <span class="inline-flex items-center justify-center bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 ltr:rounded-l-xl rtl:rounded-r-xl px-3 text-sm text-gray-500 dark:text-gray-400 font-bold tracking-wider">+20</span>
                            <input type="tel" id="settingsPhone" class="flex-1 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 ltr:rounded-r-xl rtl:rounded-l-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none dark:text-white" placeholder="01XXXXXXXXX">
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t dark:border-gray-700">
                        <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1" data-i18n="settings_change_pass">Change Password</label>
                        <div class="relative group">
                            <input type="password" id="settingsNewPassword" placeholder="New Password" data-i18n-placeholder="new_password" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none dark:text-white mb-2 ltr:pr-10 rtl:pl-10">
                            <button type="button" onclick="togglePassword('settingsNewPassword')" class="absolute ltr:right-3 rtl:left-3 top-[43%] -translate-y-1/2 text-gray-400 hover:text-brandGold transition-colors focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                        </div>
                        <p class="text-[10px] text-gray-400 italic" data-i18n="leave_empty_keep">* Leave empty to keep current password</p>
                    </div>

                    <!-- Appearance Settings -->
                    <div class="pt-4 border-t dark:border-gray-700">
                        <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-3" data-i18n="appearance">Appearance</label>
                        
                        <!-- Manual Theme Toggle -->
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-100 dark:border-gray-700 mb-2">
                            <div>
                                <p class="text-sm font-bold text-gray-700 dark:text-gray-200" data-i18n="manual_theme">Dark Mode</p>
                                <p class="text-[10px] text-gray-400 italic" data-i18n="manual_theme_desc">Switch between light and dark themes</p>
                            </div>
                            <button type="button" onclick="toggleDarkMode()" class="relative w-10 h-10 rounded-full bg-gray-200 dark:bg-[#061e31] transition-all duration-500 flex items-center shadow-inner overflow-hidden ring-1 ring-black/5 dark:ring-white/20 group cursor-pointer" id="darkToggle">
                                <div class="knob absolute left-1 top-1 bg-white dark:bg-darkCard w-8 h-8 rounded-full shadow-md grid place-items-center dark:shadow-[0_0_10px_rgba(255,255,255,0.1)] transition-colors duration-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-brandGold transition-opacity duration-300 col-start-1 row-start-1 opacity-100 dark:opacity-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <circle cx="12" cy="12" r="4" stroke-width="2"></circle>
                                        <path stroke-linecap="round" stroke-width="2" d="M12 2v2m0 16v2m8-10h2M2 12h2m14.14-7.07l-1.41 1.41M4.93 19.07l1.41-1.41M19.07 19.07l-1.41-1.41M4.93 4.93l1.41 1.41" />
                                    </svg>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-brandGold transition-opacity duration-300 col-start-1 row-start-1 opacity-0 dark:opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 6l1 2 2 1-2 1-1 2-1-2-2-1 2-1 1-2z M5 8l1 1 1 .5-1 .5-1 1-.5-1-1-.5 1-.5 .5-1z" class="opacity-0 dark:opacity-100" />
                                    </svg>
                                </div>
                            </button>
                        </div>
                        
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-100 dark:border-gray-700">
                            <div>
                                <p class="text-sm font-bold text-gray-700 dark:text-gray-200" data-i18n="auto_theme">Auto Day/Night Mode</p>
                                <p class="text-[10px] text-gray-400 italic" data-i18n="auto_theme_desc">Switch based on sun time (10 min reset)</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="settingsAutoTheme" class="sr-only peer" onchange="toggleAutoTheme(this.checked)">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none ring-4 ring-brandGold/10 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-brandGold"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Delete Account -->
                    <div class="pt-6 border-t dark:border-gray-700 mt-6">
                        <button type="button" onclick="window.confirmDeleteAccount()" class="w-full px-4 py-3 bg-red-50 dark:bg-red-900/10 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/20 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2 group border border-red-100 dark:border-red-900/20">
                            <svg class="w-3.5 h-3.5 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            <span data-i18n="delete_account">Delete Account</span>
                        </button>
                        <p class="text-[9px] text-gray-400 text-center mt-2 italic shadow-sm" data-i18n="delete_warning">This action is permanent and cannot be undone.</p>
                    </div>
                </div>

                <div id="settingsMessage" class="hidden text-center text-xs p-2 rounded-lg"></div>

                <div class="flex space-x-3 pt-6">
                    <button type="button" onclick="closeUserSettingsModal()" class="flex-1 px-4 py-3 text-gray-500 font-bold text-sm bg-gray-50 dark:bg-gray-800 rounded-xl hover:bg-gray-100 transition-all" data-i18n="cancel">Cancel</button>
                    <button type="submit" id="saveSettingsBtn" class="flex-2 px-8 py-3 bg-brandBlue text-white rounded-xl font-black text-sm border border-brandGold/30 shadow-lg shadow-brandBlue/20 hover:scale-105 transition-all" data-i18n="save_changes">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[200] transition-all duration-300">
        <div class="modal-overlay absolute w-full h-full bg-gray-900/60 backdrop-blur-sm" onclick="closeConfirmModal()"></div>
        <div class="modal-container bg-white dark:bg-darkCard w-[90%] max-w-sm mx-auto rounded-3xl shadow-2xl z-50 overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="p-8 text-center">
                <div id="confirmIconContainer" class="w-16 h-16 bg-red-50 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg id="confirmIcon" class="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 id="confirmTitle" class="text-xl font-black text-brandBlue dark:text-brandGold uppercase italic mb-2">Are you sure?</h3>
                <p id="confirmMessage" class="text-sm text-gray-500 dark:text-gray-400 mb-8 leading-relaxed">This action cannot be undone.</p>
                
                <div class="flex gap-3">
                    <button onclick="closeConfirmModal()" class="flex-1 px-4 py-3 bg-gray-50 dark:bg-gray-800 text-gray-500 font-bold text-xs rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-all uppercase tracking-widest">Cancel</button>
                    <button id="confirmActionBtn" class="flex-1 px-4 py-3 bg-red-500 text-white font-bold text-xs rounded-xl hover:bg-red-600 shadow-lg shadow-red-500/20 transition-all uppercase tracking-widest">Yes, Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Edit Modal (Admin Only) -->
    <div id="productModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[150]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900/60 backdrop-blur-sm" onclick="window.closeQuickEdit()"></div>
        <div class="modal-container bg-white dark:bg-darkCard w-11/12 md:max-w-lg mx-auto rounded-3xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] border border-brandGold/20">
            <div class="modal-content py-6 px-8 text-left">
                <div class="flex justify-between items-center pb-4 border-b dark:border-gray-700">
                    <p class="text-xl font-black text-brandBlue dark:text-brandGold uppercase italic tracking-tighter" id="modalTitle">Edit Piece</p>
                    <div class="cursor-pointer dark:text-gray-400 bg-gray-50 dark:bg-gray-800 p-2 rounded-full hover:text-red-500 transition-all shadow-sm" onclick="window.closeQuickEdit()">✕</div>
                </div>
                <form id="productForm" class="space-y-4 mt-6">
                    <input type="hidden" id="productId">
                    <div>
                        <label class="block text-[10px] font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1.5">Piece Name</label>
                        <input type="text" id="pName" required class="w-full bg-gray-50 dark:bg-gray-800/50 border dark:border-gray-700 dark:text-white rounded-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1.5">Category</label>
                        <select id="pCategory" class="w-full bg-gray-50 dark:bg-gray-800/50 border dark:border-gray-700 dark:text-white rounded-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none transition-all cursor-pointer">
                            <!-- Options injected by JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1.5">Description</label>
                        <textarea id="pDesc" required rows="3" class="w-full bg-gray-50 dark:bg-gray-800/50 border dark:border-gray-700 dark:text-white rounded-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none transition-all resize-none"></textarea>
                    </div>
                    
                    <div class="border-t dark:border-gray-700 pt-6">
                        <label class="block text-[10px] font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-3">Product Images</label>
                        <div id="imageInputs" class="space-y-4 max-h-[30vh] overflow-y-auto pr-2 custom-scroll">
                            <!-- Image inputs injected by JS -->
                        </div>
                        <p class="text-[9px] text-gray-400 mt-3 italic font-medium leading-relaxed">* Use the radio button to set the main cover image. You can paste URLs or upload files.</p>
                        <button type="button" onclick="window.addImageInput()" class="mt-4 text-[10px] text-brandGold font-black uppercase tracking-widest hover:text-brandBlue dark:hover:text-white transition-colors flex items-center gap-1.5">
                            <span class="w-5 h-5 bg-brandGold/10 rounded-full flex items-center justify-center">+</span>
                            Add More Images
                        </button>
                    </div>

                    <div class="flex gap-3 pt-8">
                        <button type="button" onclick="window.closeQuickEdit()" class="flex-1 px-4 py-3 text-gray-500 font-bold text-xs bg-gray-50 dark:bg-gray-800 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-all uppercase tracking-widest">Cancel</button>
                        <button type="submit" class="flex-2 px-8 py-3 bg-brandBlue text-white rounded-xl font-black text-sm border border-brandGold shadow-lg shadow-brandBlue/20 hover:scale-[1.02] active:scale-[0.98] transition-all uppercase tracking-widest">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Contact Picker Modal -->
    <div id="contactPickerModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[120] transition-all duration-300">
        <div class="absolute w-full h-full bg-black/60 backdrop-blur-sm" onclick="closeContactPicker()"></div>
        <div class="bg-white dark:bg-darkCard w-11/12 max-w-xs mx-auto rounded-3xl shadow-2xl z-[130] overflow-hidden relative border border-brandGold/20">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-brandGold/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-brandGold" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                </div>
                <h3 class="text-xl font-black text-brandBlue dark:text-brandGold uppercase italic mb-6" data-i18n="contact_picker_title">Contact Us</h3>
                <div id="contactPickerList" class="space-y-3">
                    <!-- Numbers will be injected here -->
                </div>
                <button onclick="closeContactPicker()" class="mt-8 text-gray-400 font-bold hover:text-red-500 transition-colors uppercase text-xs tracking-widest" data-i18n="cancel">Close</button>
            </div>
        </div>
    </div>

    <!-- Shopping Cart Modal -->
    <div id="cartModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[140] transition-all duration-300">
        <div class="absolute w-full h-full bg-black/60 backdrop-blur-sm" onclick="closeCart()"></div>
        <div class="bg-white dark:bg-darkCard w-11/12 max-w-2xl mx-auto rounded-3xl shadow-2xl z-[150] overflow-hidden relative border border-brandGold/20 flex flex-col max-h-[85vh]">
            <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-brandGold/10 rounded-full flex items-center justify-center text-brandGold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-black text-brandBlue dark:text-brandGold uppercase italic tracking-tight">Shopping Cart | عربة التسوق</h2>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest" id="cartTotalItems">0 Items | عبوة</p>
                        <p class="text-[9px] text-brandGold font-bold uppercase tracking-widest" id="cartCategoryCount"></p>
                    </div>
                </div>
                <button onclick="closeCart()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors bg-white dark:bg-gray-700 rounded-full shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div id="cartItemsList" class="p-6 overflow-y-auto custom-scroll flex-1 space-y-4">
                <!-- Cart Items Injected Here -->
            </div>

            <div class="p-6 border-t dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50 space-y-4">
                <!-- Cart Total -->
                <div id="cartTotalSection" class="hidden">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-500 font-bold uppercase tracking-wider">Total | الاجمالى</span>
                        <span id="cartTotalPrice" class="text-xl font-black text-green-600">0.00 EGP</span>
                    </div>
                </div>
                <button onclick="checkout()" id="checkoutBtn" class="w-full py-4 bg-brandBlue text-white rounded-xl font-black text-sm border border-brandGold shadow-lg shadow-brandBlue/20 hover:scale-[1.02] active:scale-[0.98] transition-all uppercase tracking-widest disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3">
                    <span>Checkout Order</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Wholesale Cart Modal -->
    <div id="wholesaleCartModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[140] transition-all duration-300">
        <div class="absolute w-full h-full bg-black/60 backdrop-blur-sm" onclick="closeWholesaleCart()"></div>
        <div class="bg-white dark:bg-darkCard w-11/12 max-w-2xl mx-auto rounded-3xl shadow-2xl z-[150] overflow-hidden relative border-2 border-brandGold/40 flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-brandGold/20 flex justify-between items-center bg-brandGold/5 dark:bg-brandGold/10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-brandGold/20 rounded-full flex items-center justify-center text-brandGold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-black text-brandGold uppercase italic tracking-tight">Wholesale Order</h2>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest" id="wholesaleCartTotalItems">0 Items</p>
                    </div>
                </div>
                <button onclick="closeWholesaleCart()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors bg-white dark:bg-gray-700 rounded-full shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div id="wholesaleCartItemsList" class="p-6 overflow-y-auto custom-scroll flex-1 space-y-4">
                <!-- Wholesale Cart Items Injected Here -->
            </div>

            <div class="p-6 border-t border-brandGold/20 bg-brandGold/5 dark:bg-brandGold/10 space-y-4">
                <div id="wholesaleCartTotalSection" class="hidden">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-brandGold font-bold uppercase tracking-wider">Total (Wholesale)</span>
                        <span id="wholesaleCartTotalPrice" class="text-xl font-black text-brandGold">0.00 EGP</span>
                    </div>
                </div>
                <button onclick="wholesaleCheckout()" id="wholesaleCheckoutBtn" class="w-full py-4 bg-brandGold text-brandBlue rounded-xl font-black text-sm border border-brandGold shadow-lg shadow-brandGold/20 hover:scale-[1.02] active:scale-[0.98] transition-all uppercase tracking-widest disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3">
                    <span>Checkout Wholesale</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[200] flex flex-col items-center gap-3 pointer-events-none"></div>

    <!-- Notifications Panel -->
    <div id="notifPanel" class="hidden fixed inset-0 md:inset-auto md:top-20 md:right-8 md:w-96 md:max-h-[70vh] md:rounded-2xl bg-white dark:bg-darkCard shadow-2xl border-0 md:border border-gray-200 dark:border-gray-700 z-[160] overflow-hidden flex flex-col">
        <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-sm font-black text-brandBlue dark:text-brandGold uppercase tracking-widest">Notifications | الإشعارات</h3>
            <div class="flex items-center gap-3">
                <button onclick="window.markAllNotificationsRead()" class="text-[10px] font-bold text-brandGold hover:underline uppercase tracking-widest">Mark all read</button>
                <button onclick="window.closeNotifications()" class="md:hidden w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors bg-white dark:bg-gray-700 rounded-full shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
        <div id="notifList" class="flex-1 overflow-y-auto divide-y divide-gray-100 dark:divide-gray-800">
            <div class="flex flex-col items-center justify-center py-12 text-gray-400 opacity-60">
                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                <p class="text-xs font-bold uppercase tracking-widest">No notifications</p>
                <p class="text-[10px] mt-1">لا توجد إشعارات</p>
            </div>
        </div>
    </div>
    <div id="notifOverlay" class="hidden fixed inset-0 z-[155]" onclick="window.closeNotifications()"></div>

    <script src="locales-data.js"></script>
    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, onSnapshot, query, orderBy, getDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, addDoc, serverTimestamp, enableIndexedDbPersistence, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_oTePhmWmzuOcZDmc_-7bhoAVbYVhH3Q",
            authDomain: "houseofglass-440.firebaseapp.com",
            projectId: "houseofglass-440",
            storageBucket: "houseofglass-440.firebasestorage.app",
            messagingSenderId: "73082039144",
            appId: "1:73082039144:web:0658e54416293334dc84dd",
            measurementId: "G-S81YY4Z4RM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Enable Offline Persistence for faster loads
        enableIndexedDbPersistence(db)
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    // Multiple tabs open, persistence can only be enabled in one tab at a a time.
                    console.warn("Persistence failed: Multiple tabs open");
                } else if (err.code == 'unimplemented') {
                    // The current browser does not support all of the features required to enable persistence
                    console.warn("Persistence not supported by browser");
                }
            });

        // --- Custom Toast Notification ---
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            // Simplified logic: success (gold) or error (red)
            const isError = type === 'error';
            
            toast.className = `
                pointer-events-auto flex items-center gap-3 px-5 py-3 rounded-2xl shadow-2xl 
                transform -translate-y-full opacity-0 transition-all duration-500 ease-[cubic-bezier(0.68,-0.55,0.265,1.55)]
                backdrop-blur-md border border-white/10 min-w-[280px]
                ${isError ? 'bg-red-500/90 text-white' : 'bg-brandGold/90 text-brandBlue'}
            `;
            
            toast.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${isError ? 'bg-white/20' : 'bg-brandBlue/10'}">
                    ${isError 
                        ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'
                        : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                    }
                </div>
                <div class="flex-1 font-bold text-sm tracking-wide">${message}</div>
            `;

            container.appendChild(toast);
            
            // Animate In: slide down from top
            setTimeout(() => { toast.classList.remove('-translate-y-full'); toast.classList.remove('opacity-0'); }, 100);

            // Auto Remove
            const removeToast = () => {
                toast.classList.add('-translate-y-full', 'opacity-0');
                setTimeout(() => toast.remove(), 500);
            };

            const timer = setTimeout(removeToast, 4000);
            toast.onclick = () => { clearTimeout(timer); removeToast(); };
        };

        let products = [];
        let categories = ['All'];
        let activeCategory = 'All';
        let searchQuery = '';
        let whatsappNumber = '201026600350';
        let sitePhones = [];
        let currentUser = null;
        let userFavorites = [];
        let userRole = 'customer';
        let userNotifications = [];
        let notifUnsubscribe = null;

        // --- Notifications System ---
        function startNotificationsListener(uid) {
            if (notifUnsubscribe) notifUnsubscribe();
            // Simple query without orderBy to avoid needing composite index
            const q = query(
                collection(db, "notifications"),
                where("userId", "==", uid)
            );
            notifUnsubscribe = onSnapshot(q, (snapshot) => {
                const prevIds = new Set(userNotifications.map(n => n.id));
                userNotifications = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                // Sort client-side by createdAt descending
                userNotifications.sort((a, b) => {
                    const aTime = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                    const bTime = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                    return bTime - aTime;
                });
                renderNotifications();
                updateNotifBadge();

                // Show toast for new unread notifications
                userNotifications.forEach(n => {
                    if (!n.read && !prevIds.has(n.id)) {
                        window.showToast(n.title || 'New notification | إشعار جديد');
                    }
                });
            }, (error) => {
                console.error("Notifications listener error:", error);
                // If composite index needed, the error message contains the creation link
                if (error.message && error.message.includes('index')) {
                    console.warn("Firestore composite index needed. Check the error above for the link.");
                }
            });
        }

        function stopNotificationsListener() {
            if (notifUnsubscribe) { notifUnsubscribe(); notifUnsubscribe = null; }
            userNotifications = [];
            updateNotifBadge();
        }

        function updateNotifBadge() {
            const unread = userNotifications.filter(n => !n.read).length;
            
            // Update all badge elements
            ['notifFloatingBadge', 'notifDesktopBadge'].forEach(id => {
                const badge = document.getElementById(id);
                if (badge) {
                    if (unread > 0) {
                        badge.textContent = unread > 9 ? '9+' : unread;
                        badge.classList.remove('opacity-0', 'scale-0');
                        badge.classList.add('opacity-100', 'scale-100');
                    } else {
                        badge.classList.add('opacity-0', 'scale-0');
                        badge.classList.remove('opacity-100', 'scale-100');
                    }
                }
            });

            // Toggle shake/float animation on floating button
            const floatingBtn = document.getElementById('notifFloatingBtn');
            const desktopBtn = document.getElementById('notifDesktopBtn');
            if (floatingBtn) {
                if (unread > 0) floatingBtn.classList.add('has-unread');
                else floatingBtn.classList.remove('has-unread');
            }
            if (desktopBtn) {
                if (unread > 0) desktopBtn.classList.add('has-unread');
                else desktopBtn.classList.remove('has-unread');
            }
        }

        function renderNotifications() {
            const container = document.getElementById('notifList');
            if (!container) return;

            if (userNotifications.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 text-gray-400 opacity-60">
                    <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <p class="text-xs font-bold uppercase tracking-widest">No notifications</p>
                    <p class="text-[10px] mt-1">\u0644\u0627 \u062a\u0648\u062c\u062f \u0625\u0634\u0639\u0627\u0631\u0627\u062a</p>
                </div>`;
                return;
            }

            container.innerHTML = userNotifications.map(n => {
                const isUnread = !n.read;
                const timeAgo = n.createdAt ? getTimeAgo(n.createdAt.toDate ? n.createdAt.toDate() : new Date(n.createdAt)) : '';
                
                // Icon & color based on type
                let iconColor = isUnread ? 'bg-green-500/10 text-green-500' : 'bg-gray-100 dark:bg-gray-800 text-gray-400';
                let iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>';
                if (n.type === 'order_completed') {
                    iconColor = isUnread ? 'bg-blue-500/10 text-blue-500' : 'bg-gray-100 dark:bg-gray-800 text-gray-400';
                    iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
                } else if (n.type === 'order_cancelled') {
                    iconColor = isUnread ? 'bg-red-500/10 text-red-500' : 'bg-gray-100 dark:bg-gray-800 text-gray-400';
                    iconSvg = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
                }
                
                return `
                <div class="px-4 py-3 flex items-start gap-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors ${isUnread ? 'bg-brandGold/5' : ''}" onclick="window.markNotificationRead('${n.id}')">
                    <div class="w-9 h-9 rounded-full flex-shrink-0 flex items-center justify-center ${iconColor}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">${iconSvg}</svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold text-brandBlue dark:text-white ${isUnread ? '' : 'opacity-60'}">${n.title || ''}</p>
                        <p class="text-[10px] text-gray-500 dark:text-gray-400 mt-0.5 leading-relaxed whitespace-pre-line">${n.message || ''}</p>
                        <p class="text-[9px] text-gray-400 mt-1 uppercase tracking-widest">${timeAgo}</p>
                    </div>
                    ${isUnread ? `<div class="w-2 h-2 rounded-full ${n.type === 'order_cancelled' ? 'bg-red-500' : n.type === 'order_completed' ? 'bg-blue-500' : 'bg-green-500'} flex-shrink-0 mt-1.5"></div>` : ''}
                </div>`;
            }).join('');
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        }

        window.toggleNotifications = function() {
            const panel = document.getElementById('notifPanel');
            const overlay = document.getElementById('notifOverlay');
            if (!panel) return;
            const isOpen = !panel.classList.contains('hidden');
            if (isOpen) {
                window.closeNotifications();
            } else {
                panel.classList.remove('hidden');
                overlay.classList.remove('hidden');
            }
        };

        window.closeNotifications = function() {
            const panel = document.getElementById('notifPanel');
            const overlay = document.getElementById('notifOverlay');
            if (panel) panel.classList.add('hidden');
            if (overlay) overlay.classList.add('hidden');
        };

        window.markNotificationRead = async function(notifId) {
            try {
                await updateDoc(doc(db, "notifications", notifId), { read: true });
            } catch(e) { console.error("Error marking notification read:", e); }
        };

        window.markAllNotificationsRead = async function() {
            const unread = userNotifications.filter(n => !n.read);
            for (const n of unread) {
                try {
                    await updateDoc(doc(db, "notifications", n.id), { read: true });
                } catch(e) { console.error("Error marking notification read:", e); }
            }
        };

        const grid = document.getElementById('product-grid');
        const modal = document.getElementById('detailModal');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const searchInput = document.getElementById('searchInput');

        window.togglePassword = (id) => {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        };

        // User Settings Functions
        window.openUserSettingsModal = async () => {
            if (!currentUser) return;
            const userDoc = await getDoc(doc(db, "users", currentUser.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('settingsUsername').value = data.username || '';
                document.getElementById('settingsFirstName').value = data.firstName || '';
                document.getElementById('settingsLastName').value = data.lastName || '';
                document.getElementById('settingsEmail').value = currentUser.email || data.email || '';
                
                // If phone exists and starts with +20, strip it for display in the input
                let displayPhone = data.phone || '';
                if (displayPhone.startsWith('+20')) {
                    displayPhone = displayPhone.substring(3);
                }
                document.getElementById('settingsPhone').value = displayPhone;

                if (data.photoURL) {
                    document.getElementById('settingsPhotoPreview').innerHTML = `<img src="${data.photoURL}" class="w-full h-full object-cover">`;
                } else {
                    document.getElementById('settingsPhotoPreview').innerText = (data.name?.[0] || currentUser.email[0]).toUpperCase();
                }
            }
            // Load auto theme setting
            document.getElementById('settingsAutoTheme').checked = localStorage.getItem('autoThemeEnabled') !== 'false';
            
            document.getElementById('userSettingsModal').classList.remove('opacity-0', 'pointer-events-none');
        };

        window.toggleAutoTheme = (enabled) => {
            localStorage.setItem('autoThemeEnabled', enabled);
            if (enabled) {
                // If turning ON, clear manual toggle and apply immediately
                localStorage.removeItem('darkMode');
                localStorage.removeItem('themeOverrideTime');
                applySmartTheme();
            }
        };

        window.closeUserSettingsModal = () => {
            document.getElementById('userSettingsModal').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('settingsMessage').className = 'hidden';
            document.getElementById('settingsNewPassword').value = '';
        };

        window.handleUserPhoto = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('settingsPhotoPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                    document.getElementById('settingsPhotoPreview').dataset.newPhoto = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // Helper to Compress Images before saving to Firestore (Avoiding Storage Bucket dependency)
        function compressImage(base64Str, maxWidth = 1000, maxHeight = 1000) {
            return new Promise((resolve) => {
                let img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    let canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    let ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // Compress to 70% quality JPEG
                };
            });
        }

        document.getElementById('userSettingsForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveSettingsBtn');
            const msg = document.getElementById('settingsMessage');
            const username = document.getElementById('settingsUsername').value.trim();
            const firstName = document.getElementById('settingsFirstName').value.trim();
            const lastName = document.getElementById('settingsLastName').value.trim();
            let phone = document.getElementById('settingsPhone').value.trim();
            const pass = document.getElementById('settingsNewPassword').value;
            const photoPreview = document.getElementById('settingsPhotoPreview');
            const photo = photoPreview.dataset.newPhoto;

            if (phone) {
                // Ensure +20 format
                phone = "+20" + phone.replace(/^0/, '').replace(/^\+20/, '');
            }

            const fullName = `${firstName} ${lastName}`;

            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                const updates = { 
                    username, 
                    firstName, 
                    lastName, 
                    name: fullName, 
                    phone 
                };
                
                // If there's a new photo, compress and save Base64 directly to Firestore
                if (photo && photo.startsWith('data:image')) {
                    // Compress to reduce size (same approach used in admin panel)
                    msg.innerText = 'Processing photo...';
                    msg.className = 'text-center text-xs p-2 rounded-lg bg-brandGold/10 text-brandGold block mt-4';
                    const compressed = await compressImage(photo, 800, 800);
                    updates.photoURL = compressed;
                }
                
                await updateDoc(doc(db, "users", currentUser.uid), updates);

                if (pass) {
                    await updatePassword(currentUser, pass);
                }

                msg.innerText = "Profile updated successfully!";
                msg.className = "text-center text-xs p-2 rounded-lg bg-green-100 text-green-700 block bg-opacity-50 mt-4 font-bold";
                
                setTimeout(() => {
                    closeUserSettingsModal();
                    location.reload(); // Refresh to show new name/photo
                }, 1500);

            } catch (error) {
                msg.innerText = "Error: " + error.message;
                msg.className = "text-center text-xs p-2 rounded-lg bg-red-100 text-red-700 block bg-opacity-50 mt-4";
                btn.disabled = false;
                btn.innerText = "Save Changes";
            }
        };

        // --- Quick Edit Logic ---
        window.closeQuickEdit = function() {
            document.getElementById('productModal').classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        };

        window.addImageInput = function(val = '', isDefault = false) {
            const div = document.createElement('div');
            div.className = 'image-row flex items-center space-x-3 bg-gray-50 dark:bg-gray-800/50 p-3 rounded-xl border border-gray-100 dark:border-gray-700 relative group/img';
            div.innerHTML = `
                <input type="radio" name="defaultImage" ${isDefault ? 'checked' : ''} class="w-4 h-4 accent-brandGold cursor-pointer shrink-0" title="Set as main image">
                <div class="w-12 h-12 bg-white dark:bg-gray-700 rounded-lg border dark:border-gray-600 overflow-hidden flex-shrink-0 shadow-sm relative">
                    <img src="${val || ''}" class="img-preview w-full h-full object-cover ${val ? '' : 'hidden'}">
                    <div class="absolute inset-0 bg-black/10 flex items-center justify-center pointer-events-none ${val ? 'hidden' : ''}">
                        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    </div>
                </div>
                <div class="flex-grow space-y-1">
                    <input type="hidden" value="${val}" class="pImageUrl">
                    <div class="flex items-center space-x-2">
                        <label class="cursor-pointer bg-brandGold text-brandBlue px-4 py-2 rounded-lg text-xs font-bold hover:bg-opacity-90 transition-all shadow-sm active:scale-95 flex items-center gap-2 justify-center w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Upload Image
                            <input type="file" class="hidden" accept="image/*" onchange="window.handleFile(this)">
                        </label>
                    </div>
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="delete-img opacity-0 group-hover/img:opacity-100 text-red-400 hover:text-red-500 transition-all p-1">✕</button>
            `;
            document.getElementById('imageInputs').appendChild(div);
        };

        window.updatePreview = function(input) {
            const row = input.closest('.image-row');
            const preview = row.querySelector('.img-preview');
            const placeholder = row.querySelector('.absolute.inset-0.bg-black\\/10');
            if (input.value) {
                preview.src = input.value;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        };

        window.handleFile = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const row = input.closest('.image-row');
                    const urlInput = row.querySelector('.pImageUrl');
                    urlInput.value = e.target.result;
                    window.updatePreview(urlInput);
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.editProduct = function(id) {
            const p = products.find(prod => prod.id === id);
            if (p) {
                // Populate categories dropdown for the modal
                const select = document.getElementById('pCategory');
                select.innerHTML = categories.filter(c => c !== 'All' && c !== 'My Favorites').map(c => `<option value="${c}">${c}</option>`).join('');
                
                document.getElementById('productId').value = p.id;
                document.getElementById('pName').value = p.name;
                document.getElementById('pCategory').value = p.category;
                document.getElementById('pDesc').value = p.desc;
                document.getElementById('imageInputs').innerHTML = '';
                p.images.forEach((url, idx) => window.addImageInput(url, idx === 0));
                
                document.getElementById('productModal').classList.remove('opacity-0', 'pointer-events-none');
                document.body.classList.add('modal-active');
            }
        };

        // Cloudinary Configuration
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dbr22ce0m/image/upload";
        const CLOUDINARY_PRESET = "house_of_glass";

        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", CLOUDINARY_PRESET);

            try {
                const response = await fetch(CLOUDINARY_URL, {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) throw new Error("Cloudinary upload failed");

                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error("Cloudinary Error:", error);
                throw error;
            }
        }

        document.getElementById('productForm').onsubmit = async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = "Saving...";

            const id = document.getElementById('productId').value;
            const rows = Array.from(document.querySelectorAll('#imageInputs > div'));
            let imgs = [];
            let mainIdx = 0;

            try {
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    let url = row.querySelector('.pImageUrl').value;
                    const isMain = row.querySelector('input[type="radio"]').checked;
                    
                    // Check if there is a file selected in the file input for this row
                    const fileInput = row.querySelector('input[type="file"]');
                    
                    if (fileInput && fileInput.files.length > 0) {
                        submitBtn.innerText = `Uploading ${i+1}/${rows.length}...`;
                        url = await uploadToCloudinary(fileInput.files[0]);
                    } else if(url && url.startsWith('data:')) {
                        // Fallback for pasted base64 or legacy
                        // Convert base64 to blob and upload
                         submitBtn.innerText = `Uploading ${i+1}/${rows.length}...`;
                         const res = await fetch(url);
                         const blob = await res.blob();
                         url = await uploadToCloudinary(blob);
                    }
                    
                    if(url) {
                        imgs.push(url);
                        if(isMain) mainIdx = imgs.length - 1;
                    }
                }

                if(imgs.length > 0) {
                    const main = imgs.splice(mainIdx, 1)[0];
                    imgs.unshift(main); 
                }

                const data = {
                    name: document.getElementById('pName').value,
                    category: document.getElementById('pCategory').value,
                    desc: document.getElementById('pDesc').value,
                    images: imgs,
                    updatedAt: serverTimestamp()
                };

                await updateDoc(doc(db, "products", id), data);
                
                window.closeQuickEdit();
                window.showDetails(id); // Refresh the detail modal to show new data
                window.showToast("Piece updated successfully!");
                
            } catch (err) {
                console.error("Error in save process:", err);
                window.showToast(`Error: ${err.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
            }
        };

        // Auth listener
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const sidebarFooter = document.querySelector('#sidebar .border-t');
            const headerNav = document.getElementById('headerNav');
            const homeLink = `<a href="index.html" class="text-brandBlue dark:text-white border-b-2 border-brandGold px-1 py-1 text-sm font-bold" data-i18n="home">Home</a>`;
            
            if (user) {
                // Initialize default USER DATA to prevent crash if doc fetch fails
                 let userData = {
                     name: user.email.split('@')[0],
                     photoURL: null,
                     role: 'customer',
                     favorites: []
                };

                try {
                     const userDoc = await getDoc(doc(db, "users", user.uid));
                     if (userDoc.exists()) {
                         const d = userDoc.data();
                         userData.name = d.name || userData.name;
                         userData.photoURL = d.photoURL;
                         userData.role = d.role || 'customer';
                         userData.favorites = d.favorites || [];
                     }
                } catch(e) {
                    console.error("User doc fetch error", e);
                }
                
                userFavorites = userData.favorites;
                userRole = userData.role;

                // Start notifications listener
                const notifFloating = document.getElementById('notifFloatingBtn');
                const notifDesktop = document.getElementById('notifDesktopBtn');
                if (notifFloating) { notifFloating.classList.remove('hidden'); notifFloating.classList.add('flex'); }
                if (notifDesktop) { notifDesktop.classList.remove('hidden'); notifDesktop.classList.add('hidden', 'md:flex'); }
                startNotificationsListener(user.uid);

                // Check if there's a pending checkout after login/signup
                const urlAction = new URLSearchParams(window.location.search).get('action');
                const hasPendingCheckout = localStorage.getItem('pendingCheckout') === 'true' || urlAction === 'checkout';
                if (hasPendingCheckout) {
                    localStorage.removeItem('pendingCheckout');
                    // Clean up URL param
                    if (urlAction) {
                        const cleanUrl = window.location.pathname;
                        window.history.replaceState({}, '', cleanUrl);
                    }
                    setTimeout(() => {
                        openCart();
                        window.showToast('Welcome back! Continue with your order.', 'success');
                    }, 800);
                }

                const displayRole = userRole === 'customer' ? 'CST. Retail' : 
                                   (userRole === 'cst_wholesale' ? 'CST. Wholesale' : userRole);

                // Show/hide wholesale cart button based on role
                const wCartBtn = document.getElementById('wholesaleCartBtn');
                if (wCartBtn) {
                    if (userRole !== 'customer') {
                        wCartBtn.classList.remove('hidden');
                    } else {
                        wCartBtn.classList.add('hidden');
                    }
                }

                // Update Header Nav
                if (userRole === 'admin' || userRole === 'moderator') {
                    headerNav.innerHTML = `${homeLink} <a href="admin.html" class="text-brandGold hover:text-brandBlue dark:hover:text-white px-1 py-1 text-sm font-bold transition-colors" data-i18n="admin_dashboard">Admin Dashboard</a>`;
                } else {
                    headerNav.innerHTML = homeLink;
                }

                // Update Footer
                sidebarFooter.style.display = 'block';
                sidebarFooter.innerHTML = `
                    <div class="flex flex-col space-y-2">
                        ${(userRole === 'admin' || userRole === 'moderator') ? `<a href="admin.html" class="block text-center bg-brandBlue text-white py-2.5 rounded-xl font-bold border border-brandGold hover:bg-opacity-90 text-xs shadow-xl shadow-brandBlue/20" data-i18n="admin_dashboard">Admin Dashboard</a>` : ''}
                    </div>
                `;
                
                // Replace header with profile card
                const sidebarHeader = document.getElementById('sidebarHeader');
                sidebarHeader.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center space-x-3 flex-1">
                                <div onclick="window.openUserSettingsModal()" class="w-10 h-10 rounded-full bg-brandGold flex items-center justify-center text-white text-sm font-bold shadow-lg shadow-brandGold/20 overflow-hidden cursor-pointer hover:scale-105 transition-transform">
                                    ${userData.photoURL ? `<img src="${userData.photoURL}" class="w-full h-full object-cover">` : userData.name[0].toUpperCase()}
                                </div>
                                <div class="overflow-hidden flex-1 cursor-pointer" onclick="window.openUserSettingsModal()">
                                    <p class="text-sm font-bold dark:text-white truncate">${userData.name}</p>
                                    <p class="text-[10px] text-brandGold uppercase font-black tracking-widest">${displayRole}</p>
                                </div>
                            </div>
                            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-brandBlue dark:hover:text-white text-xl font-bold ml-2">✕</button>
                        </div>
                `;

                // Also populate header profile card
                const headerProfile = document.getElementById('headerUserProfile');
                if (headerProfile) {
                    headerProfile.innerHTML = `
                            <div class="flex items-center space-x-2 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.openUserSettingsModal()">
                                <div class="w-6 h-6 rounded-full bg-brandGold flex items-center justify-center text-white text-[10px] font-bold shadow-lg shadow-brandGold/20 overflow-hidden">
                                    ${userData.photoURL ? `<img src="${userData.photoURL}" class="w-full h-full object-cover">` : userData.name[0].toUpperCase()}
                                </div>
                                <div class="overflow-hidden profile-text">
                                    <p class="text-[9px] font-bold dark:text-white truncate">${userData.name}</p>
                                    <p class="text-[7px] text-brandGold uppercase font-black">${displayRole}</p>
                                </div>
                            </div>
                            <button onclick="window.openUserSettingsModal()" class="hidden md:inline-block p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Settings">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brandGold" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                            <button onclick="window.logout()" class="hidden md:inline-block p-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="Logout">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                </svg>
                            </button>
                    `;
                    headerProfile.classList.remove('hidden', 'md:hidden');
                    headerProfile.classList.add('flex', 'md:flex');
                    headerProfile.dataset.mode = 'user';
                }

            } else {
                userFavorites = [];
                userRole = 'customer';

                // Stop notifications & hide bell
                stopNotificationsListener();
                const notifFloating = document.getElementById('notifFloatingBtn');
                const notifDesktop = document.getElementById('notifDesktopBtn');
                if (notifFloating) { notifFloating.classList.add('hidden'); notifFloating.classList.remove('flex'); }
                if (notifDesktop) { notifDesktop.classList.add('hidden'); notifDesktop.classList.remove('md:flex'); }
                window.closeNotifications();

                headerNav.innerHTML = `${homeLink} <a href="login.html" class="text-brandGold hover:text-brandBlue dark:hover:text-white px-1 py-1 text-sm font-bold transition-colors" data-i18n="login_signup">Login / Sign Up</a>`;
                
                // Show header login capsule on mobile with same styling as profile capsule
                const headerProfile = document.getElementById('headerUserProfile');
                if (headerProfile) {
                    headerProfile.innerHTML = `
                        <button onclick="window.location.href='login.html'" class="login-pill flex items-center justify-between gap-3 text-left group">
                            <div class="text-left profile-text">
                                <p class="text-[7px] text-brandGold uppercase font-black tracking-[0.3em]" data-i18n="login_signup">Login / Sign Up</p>
                            </div>
                            <span class="p-1 rounded-full bg-brandGold/10 text-brandGold transition-transform duration-300 group-hover:translate-x-1 group-hover:bg-brandGold/20">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </span>
                        </button>
                    `;
                    headerProfile.classList.remove('hidden', 'md:flex');
                    headerProfile.classList.add('flex', 'md:hidden');
                    headerProfile.dataset.mode = 'guest';
                }
                
                sidebarFooter.style.display = 'block';
                sidebarFooter.innerHTML = `
                    <div class="flex flex-col space-y-2">
                        <a href="login.html" class="w-full text-center bg-brandBlue text-white py-3 rounded-xl font-black border border-brandGold hover:bg-opacity-90 transition-all shadow-xl shadow-brandBlue/20 uppercase tracking-widest text-[10px]" data-i18n="login_signup">Login / Sign Up</a>
                    </div>
                `;
                
                // Keep Sidebar Header as just Title + Close for guests
                const sidebarHeader = document.getElementById('sidebarHeader');
                sidebarHeader.innerHTML = `
                    <h2 class="text-xl font-bold text-brandBlue dark:text-brandGold italic" data-i18n="categories">Categories</h2>
                    <button onclick="toggleSidebar()" class="text-gray-400 hover:text-brandBlue dark:hover:text-white text-xl font-bold">✕</button>
                `;
            }
            // Add "My Favorites" to categories if not present
            if (user && !categories.includes('My Favorites')) {
                categories.splice(1, 0, 'My Favorites');
            } else if (!user && categories.includes('My Favorites')) {
                categories = categories.filter(c => c !== 'My Favorites');
                if (activeCategory === 'My Favorites') activeCategory = 'All';
            }
            if (window.applyI18n) {
                window.applyI18n();
            }
            renderCategories();
            renderProducts();
        });

        window.logout = () => signOut(auth);

        window.confirmDeleteAccount = async () => {
            if (!currentUser) return;
            
            showConfirmModal({
                title: "Delete Account?",
                message: "⚠️ Are you absolutely sure? This will permanently delete your account, favorites, and profile data. This action cannot be undone.",
                icon: "delete",
                confirmText: "Delete Forever",
                onConfirm: async () => {
                    try {
                        const uid = currentUser.uid;
                        await deleteDoc(doc(db, "users", uid));
                        await deleteUser(currentUser);
                        window.location.reload();
                    } catch (error) {
                        console.error("Delete Error:", error);
                        if (error.code === 'auth/requires-recent-login') {
                            showToast("For security reasons, you must have logged in recently to delete your account. Please log out and log back in, then try again.", 'error');
                        } else {
                            showToast("Error: " + error.message, 'error');
                        }
                    }
                }
            });
        };

        window.showConfirmModal = ({ title, message, icon, confirmText, onConfirm }) => {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;
            document.getElementById('confirmActionBtn').innerText = confirmText;
            
            const iconContainer = document.getElementById('confirmIconContainer');
            if (icon === 'delete') {
                iconContainer.className = "w-16 h-16 bg-red-50 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4";
                document.getElementById('confirmActionBtn').className = "flex-1 px-4 py-3 bg-red-500 text-white font-bold text-xs rounded-xl hover:bg-red-600 shadow-lg shadow-red-500/20 transition-all uppercase tracking-widest";
            } else {
                iconContainer.className = "w-16 h-16 bg-brandGold/10 rounded-full flex items-center justify-center mx-auto mb-4";
                document.getElementById('confirmActionBtn').className = "flex-1 px-4 py-3 bg-brandGold text-white font-bold text-xs rounded-xl hover:bg-brandGold/80 shadow-lg shadow-brandGold/20 transition-all uppercase tracking-widest";
            }

            const btn = document.getElementById('confirmActionBtn');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => {
                onConfirm();
                closeConfirmModal();
            };

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-container').classList.remove('scale-95');
            modal.querySelector('.modal-container').classList.add('scale-100');
        };

        window.closeConfirmModal = () => {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-container').classList.remove('scale-100');
            modal.querySelector('.modal-container').classList.add('scale-95');
        };

        window.openContactPicker = () => {
            const list = document.getElementById('contactPickerList');
            list.innerHTML = sitePhones.map(p => `
                <a href="tel:${p}" class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl hover:bg-brandGold/10 transition-all group border border-transparent hover:border-brandGold/30">
                    <span class="text-sm font-bold text-brandBlue dark:text-white">${p}</span>
                    <svg class="w-5 h-5 text-brandGold group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                </a>
            `).join('');
            document.getElementById('contactPickerModal').classList.remove('opacity-0', 'pointer-events-none');
        };

        window.closeContactPicker = () => {
            document.getElementById('contactPickerModal').classList.add('opacity-0', 'pointer-events-none');
        };


        async function fetchLivePricing() {
            // Function to fetch prices from HG System (DC)
            // Endpoint: https://glass-system-backend.onrender.com/public/products (GET)
            
            const priceTags = document.querySelectorAll('.dc-price[data-code]');
            if(priceTags.length === 0) return;

            // Mark as loading
            priceTags.forEach(el => {
                if(el.innerText === '...') el.classList.add('animate-pulse');
            });

            console.log("Fetching live prices from DC...");
            
            try {
                // We use standard 'fetch' because it is built-in (No extra libraries needed)
                const res = await fetch("https://glass-system-backend.onrender.com/public/products");
                
                if (!res.ok) throw new Error("Failed to connect to DC");
                
                const data = await res.json(); 
                console.log("DC Response Sample:", data[0]); // Debugging: Check the first item structure

                const priceMap = {};
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        // Updated Matching Logic:
                        // 1. Check 'barcode' (Matches user's 90000059)
                        // 2. Check 'product_code' (Matches "58")
                        // 3. Fallback to standard keys
                        const rawCode = item.barcode || item.code || item.product_code || item.productCode || item.sku || item.id; 
                        if (rawCode) {
                            priceMap[String(rawCode).trim()] = item;
                        }
                    });
                }

                console.log("Prices loaded:", Object.keys(priceMap).length, "items");

                // Store globally so detail modal can access it
                window._dcPriceMap = priceMap;

                // Update UI
                priceTags.forEach(el => {
                    const code = String(el.dataset.code).trim();
                    el.classList.remove('animate-pulse');
                    
                    if (priceMap[code]) {
                        const info = priceMap[code];
                        // Support multiple price field names:
                        // 'retail_price' (from JSON screenshot), 'sectorSalesPrice', 'sellingPrice'
                        const price = info.retail_price || info.sectorSalesPrice || info.sellingPrice || info.price || info.salePrice || 0;
                        
                        // Stock might not be in the public feed, check multiple keys
                        const stock = info.stock || info.qty || info.quantity || 1; 
                        
                        el.innerText = `${price} EGP`;
                        
                        // Optional: Visual cue for Out of Stock in DC
                        if (stock <= 0) {
                            el.classList.add('bg-red-100', 'text-red-500', 'line-through');
                            el.title = "Out of Stock in DC";
                        } else {
                            el.classList.add('bg-green-100', 'text-green-700');
                        }
                    } else {
                        // Product found in Gallery but NOT in DC
                        console.warn(`Code ${code} not found in DC data`);
                        el.innerText = "N/A";
                        el.classList.add('bg-gray-200', 'text-gray-400', 'opacity-50');
                        el.title = "Not found in DC system";
                    }
                });

            } catch (e) {
                console.error("DC Sync Error:", e);
                // On error, hide tags or show disconnected state
                priceTags.forEach(el => {
                   if(el.innerText === '...') {
                       el.innerText = "Offline";
                       el.classList.add('text-[9px]', 'bg-gray-100');
                   }
                });
            }
        }

        // Expose to window so it can be called globally
        window.fetchLivePricing = fetchLivePricing;

        async function loadData() {
            try {
                // Load Settings (Contacts) - Live Listener
                onSnapshot(doc(db, "settings", "contact"), (docSnap) => {
                    if (docSnap.exists()) {
                        whatsappNumber = docSnap.data().whatsapp || '201026600350';
                        const fb = docSnap.data().facebook || '#';
                        const maps = docSnap.data().maps || '#';
                        const waChannel = docSnap.data().whatsappChannel || '#';

                        document.getElementById('floatingWhatsapp').href = `https://wa.me/${whatsappNumber}`;
                        document.getElementById('footerWhatsapp').href = waChannel;
                        
                        sitePhones = (docSnap.data().phone || '+201026600350').split(',').map(p => p.trim()).filter(p => p);

                        document.getElementById('footerFacebook').href = fb;
                        document.getElementById('footerMaps').href = maps;

                        const sidebarPhoneLink = document.getElementById('sidebarPhone');
                        if (sidebarPhoneLink && sitePhones.length) {
                            sidebarPhoneLink.href = `tel:${sitePhones[0]}`;
                        }

                        const sidebarWaLink = document.getElementById('sidebarWhatsapp');
                        if (sidebarWaLink) {
                            const waLink = (waChannel && waChannel !== '#') ? waChannel : `https://wa.me/${whatsappNumber}`;
                            sidebarWaLink.href = waLink;
                        }

                        const sidebarFbLink = document.getElementById('sidebarFacebook');
                        if (sidebarFbLink) sidebarFbLink.href = fb;

                        const sidebarMapLink = document.getElementById('sidebarMaps');
                        if (sidebarMapLink) sidebarMapLink.href = maps;
                    }
                });

                // Load Categories - Live Listener
                onSnapshot(collection(db, "categories"), (catSnapshot) => {
                    const fetchedCatsData = catSnapshot.docs.map((doc, idx) => {
                        const data = doc.data();
                        return { name: data.name, order: data.order !== undefined ? data.order : idx };
                    }).sort((a, b) => a.order - b.order);
                    
                    const fetchedCats = fetchedCatsData.map(c => c.name);
                    categories = ['All', ...fetchedCats];
                    if (currentUser) {
                        if (!categories.includes('My Favorites')) {
                            categories.splice(1, 0, 'My Favorites');
                        }
                    }
                    renderCategories();
                    renderProducts();
                });
                
                // Load Products - Live Listener
                onSnapshot(collection(db, "products"), (prodSnapshot) => {
                    products = prodSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sort locally to handle missing order fields gracefully
                    products.sort((a, b) => {
                        const orderA = a.order !== undefined ? a.order : 999999;
                        const orderB = b.order !== undefined ? b.order : 999999;
                        if (orderA !== orderB) return orderA - orderB;
                        const timeA = a.createdAt?.toMillis() || 0;
                        const timeB = b.createdAt?.toMillis() || 0;
                        return timeB - timeA;
                    });
                    renderProducts();
                });

            } catch (error) {
                console.error("Error loading data:", error);
            }
        }

        window.toggleSidebar = function() {
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            if (isOpen) {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
                document.body.style.overflow = '';
            } else {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('opacity-0', 'pointer-events-none');
                document.body.style.overflow = 'hidden';
            }
        }

        window.toggleCatDropdown = function() {
            const dropdown = document.getElementById('catDropdown');
            dropdown.classList.toggle('hidden');
        }

        window.addEventListener('click', (e) => {
            const dropdown = document.getElementById('catDropdown');
            if (dropdown && !dropdown.classList.contains('hidden') && !e.target.closest('.group\\/cat')) {
                dropdown.classList.add('hidden');
            }
        });

        function renderCategories() {
            const catList = document.getElementById('categoryList');
            const catDropdown = document.getElementById('catDropdown');
            catList.innerHTML = '';
            catDropdown.innerHTML = '';

            categories.forEach(cat => {
                // Sidebar
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-6 py-3.5 text-sm font-bold transition-all flex items-center space-x-3 ${activeCategory === cat ? 'text-brandGold border-r-4 border-brandGold bg-brandGold/5' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800'}`;
                btn.innerHTML = `
                    ${cat === 'My Favorites' ? '<svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>' : ''}
                    <span>${cat}</span>
                `;
                btn.onclick = () => { selectCategory(cat); window.toggleSidebar(); };
                catList.appendChild(btn);

                // Dropdown
                const dropBtn = document.createElement('button');
                dropBtn.className = `w-full text-left px-4 py-3 text-sm font-bold transition-colors hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center ${activeCategory === cat ? 'text-brandGold bg-brandGold/5' : 'text-gray-600 dark:text-gray-400'}`;
                dropBtn.innerText = cat;
                dropBtn.onclick = () => { selectCategory(cat); document.getElementById('catDropdown').classList.add('hidden'); };
                catDropdown.appendChild(dropBtn);
            });

            // Add Sign Out to Sidebar List for Logged In Users
            if (currentUser) {
                const logoutBtn = document.createElement('button');
                logoutBtn.className = "w-full text-left px-6 py-3.5 text-sm font-bold text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all flex items-center space-x-3 border-t border-gray-100 dark:border-gray-800 mt-2";
                logoutBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span data-i18n="logout">Sign Out</span>
                `;
                logoutBtn.onclick = () => {
                    window.toggleSidebar();
                    window.logout();
                };
                catList.appendChild(logoutBtn);
            }
        }

        window.selectCategory = (cat) => {
            activeCategory = cat;
            searchQuery = ''; // Clear search when selecting a category
            if(document.getElementById('searchInput')) document.getElementById('searchInput').value = '';
            
            document.getElementById('activeFilterDisplay').innerText = `Category: ${cat}`;
            renderProducts();
            renderCategories();
            
            // Scroll to the main section to see results
            const contentSection = document.getElementById('product-grid');
            if (contentSection) {
                const yOffset = -150; 
                const y = contentSection.getBoundingClientRect().top + window.pageYOffset + yOffset;
                window.scrollTo({top: y, behavior: 'smooth'});
            }
        };

        window.toggleFavorite = async (e, productId) => {
            e.stopPropagation();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            const userRef = doc(db, "users", currentUser.uid);
            const isFav = userFavorites.includes(productId);

            try {
                if (isFav) {
                    await updateDoc(userRef, { favorites: arrayRemove(productId) });
                    userFavorites = userFavorites.filter(id => id !== productId);
                } else {
                    await updateDoc(userRef, { favorites: arrayUnion(productId) });
                    userFavorites.push(productId);
                }
                renderProducts();
                // Update modal heart if open
                const modalHeart = document.querySelector('#detailModal button svg');
                if(modalHeart) modalHeart.parentElement.classList.toggle('text-red-500', !isFav);
                if(modalHeart) modalHeart.parentElement.classList.toggle('text-gray-400', isFav);
            } catch (err) {
                console.error("Error toggling favorite:", err);
            }
        };

        window.scrollCategory = (id, direction) => {
            const el = document.getElementById(id);
            if (el) {
                // Pause auto-scroll briefly
                el.dataset.manualScrolling = "true";
                setTimeout(() => {
                    delete el.dataset.manualScrolling;
                }, 1000);

                const amount = el.clientWidth * 0.8;
                el.style.scrollBehavior = 'smooth';
                el.scrollBy({ left: direction * amount, behavior: 'smooth' });
            }
        };

        function renderProducts() {
            grid.innerHTML = '';
            
            // Remove loading skeleton
            const loadingSkeleton = document.querySelector('.loading-skeleton');
            if (loadingSkeleton) loadingSkeleton.remove();
            
            // If search is active or specific category is selected, use grid mode
            if (activeCategory !== 'All' || searchQuery !== '') {
                grid.className = "grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-10";
                
                // Add Back Header
                const backHeader = document.createElement('div');
                backHeader.className = 'col-span-full flex items-center justify-between mb-8 pb-6 border-b border-gray-100 dark:border-gray-800/50 reveal';
                
                const titleText = searchQuery !== '' ? (localStorage.getItem('lang') === 'ar' ? 'نتائج البحث' : 'Search Results') : activeCategory;
                
                backHeader.innerHTML = `
                    <button onclick="selectCategory('All')" class="flex items-center gap-3 group/back text-brandBlue dark:text-brandGold hover:translate-x-[-4px] transition-transform">
                        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-brandGold/10 flex items-center justify-center group-hover/back:bg-brandGold group-hover/back:text-white transition-all shadow-sm">
                            <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] md:text-xs font-black uppercase tracking-[0.2em] leading-none">BACK | رجوع</span>
                            <span class="text-[8px] md:text-[10px] text-gray-400 group-hover/back:text-brandGold transition-colors uppercase font-bold mt-1">RETURN TO ALL | العودة للكل</span>
                        </div>
                    </button>
                    <div class="text-right">
                        <h2 class="text-lg md:text-3xl font-black text-brandBlue dark:text-brandGold uppercase italic tracking-tighter leading-none">${titleText}</h2>
                        <div class="w-12 h-1 bg-brandGold rounded-full mt-2 ml-auto"></div>
                    </div>
                `;
                grid.appendChild(backHeader);

                let filtered = products;
                if (activeCategory === 'My Favorites') {
                    filtered = products.filter(p => userFavorites.includes(p.id));
                } else if (activeCategory !== 'All') {
                    filtered = filtered.filter(p => p.category === activeCategory);
                }

                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    filtered = filtered.filter(p => 
                        p.name.toLowerCase().includes(q) || 
                        (p.category && p.category.toLowerCase().includes(q))
                    );
                }

                if (filtered.length === 0 && products.length > 0) {
                    grid.innerHTML = `<div class="col-span-full py-20 flex flex-col items-center justify-center gap-2 text-gray-400 italic text-lg">
                        <p class="font-sans">Nothing matches your search.</p>
                        <p class="font-arabic">.لا يوجد ما يطابق بحثك حالياً</p>
                    </div>`;
                    return;
                }

                filtered.forEach((p, idx) => {
                    grid.appendChild(createProductCard(p, idx));
                });
                if(window.fetchLivePricing) setTimeout(window.fetchLivePricing, 100);
            } else {
                // CATEGORY ROW MODE (All Categories Default)
                grid.className = "flex flex-col space-y-12 md:space-y-20";
                
                const actualCategories = categories.filter(c => c !== 'All' && c !== 'My Favorites');
                
                actualCategories.forEach((catName, catIdx) => {
                    const catProducts = products.filter(p => p.category === catName);
                    if (catProducts.length === 0) return;

                    const rowWrapper = document.createElement('div');
                    rowWrapper.className = 'category-row-wrapper reveal';
                    rowWrapper.style.transitionDelay = `${catIdx * 100}ms`;
                    
                    const rowId = `row-${catName.replace(/\s+/g, '-')}`;
                    
                    rowWrapper.innerHTML = `
                        <div class="flex items-center justify-between mb-6 px-1">
                            <div class="flex flex-col">
                                <h2 class="text-xl md:text-3xl font-black text-brandBlue dark:text-brandGold uppercase italic tracking-tighter">${catName}</h2>
                                <div class="w-12 h-1 bg-brandGold rounded-full mt-2"></div>
                            </div>
                            <button onclick="selectCategory('${catName}')" class="text-[10px] md:text-xs font-bold text-brandGold uppercase tracking-[0.2em] hover:translate-x-1 transition-transform">SEE ALL | عرض الكل <span class="ml-1">→</span></button>
                        </div>
                        
                        <div class="relative group/row">
                            <!-- Arrows -->
                            <button onclick="scrollCategory('${rowId}', -1)" class="scroll-arrow scroll-arrow-left">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <button onclick="scrollCategory('${rowId}', 1)" class="scroll-arrow scroll-arrow-right">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                            
                            <div id="${rowId}" class="category-row-container">
                                <!-- Cards will be injected here -->
                            </div>
                        </div>
                    `;

                    const rowContainer = rowWrapper.querySelector('.category-row-container');
                    
                    const populateRow = (isClone = false) => {
                        catProducts.forEach((p, pIdx) => {
                            const card = createProductCard(p, pIdx);
                            card.classList.add('category-card');
                            card.classList.remove('reveal');
                            if (isClone) card.setAttribute('aria-hidden', 'true');
                            rowContainer.appendChild(card);
                        });
                        // Add Separator Line only if more than 1 product
                        if (catProducts.length > 1) {
                            const separator = document.createElement('div');
                            // Use fixed width instead of margins for predictable infinite scroll math
                            // Added self-center to align it perfectly in the vertical middle of the row
                            separator.className = 'flex-shrink-0 w-12 h-64 flex justify-center items-center self-center';
                            separator.innerHTML = `
                                <div class="relative w-[2px] h-full flex items-center justify-center">
                                    <!-- Backlight (Glow behind the line) -->
                                    <div class="absolute w-16 h-[110%] bg-brandGold/5 dark:bg-brandGold/15 blur-2xl rounded-full pointer-events-none"></div>
                                    <!-- The Actual Line -->
                                    <div class="relative w-full h-full bg-brandGold/30 dark:bg-brandGold/70 rounded-full"></div>
                                </div>
                            `;
                            if (isClone) separator.setAttribute('aria-hidden', 'true');
                            rowContainer.appendChild(separator);
                        }
                    };

                    populateRow();
                    
                    grid.appendChild(rowWrapper);
                });

                // Initialize cinematic auto-scroll for the new rows
                setTimeout(initRowAutoScroll, 500); 
                if(window.fetchLivePricing) setTimeout(window.fetchLivePricing, 100);
            }

            setTimeout(initReveal, 100);
        }

        function createProductCard(p, idx) {
            const isFav = userFavorites.includes(p.id);
            const card = document.createElement('div');
            card.className = 'reveal cursor-pointer group bg-white dark:bg-darkCard/80 backdrop-blur-md rounded-xl md:rounded-3xl shadow-[0_8px_30px_rgba(0,0,0,0.04)] hover:shadow-[0_20px_50px_rgba(0,0,0,0.1)] overflow-hidden transition-all duration-700 border border-transparent dark:border-gray-800 hover:border-gray-200';
            card.style.transitionDelay = `${idx * 50}ms`;
            card.onclick = () => showDetails(p.id);
            card.innerHTML = `
                <div class="overflow-hidden h-44 md:h-72 relative bg-gray-50 dark:bg-gray-900/50 flex items-center justify-center">
                    <img src="${p.images[0] || 'https://via.placeholder.com/800x600?text=No+Image'}" class="product-card-img w-full h-full object-contain p-6 group-hover:scale-110 transition-all duration-500">
                    
                    <button onclick="toggleFavorite(event, '${p.id}')" class="absolute top-3 right-3 z-30 p-2 rounded-full bg-white/90 dark:bg-black/40 backdrop-blur-md shadow-lg hover:scale-110 active:scale-95 transition-all ${isFav ? 'text-red-500' : 'text-gray-400'}">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </button>

                    <div class="absolute top-3 left-3 bg-brandGold/90 text-white text-[8px] md:text-[10px] px-3 py-1 rounded-full font-black uppercase tracking-widest shadow-lg shadow-brandGold/20">${p.category}</div>
                    <div class="absolute bottom-3 right-3 bg-black/60 text-white text-[8px] md:text-[10px] px-3 py-1 rounded-full backdrop-blur-md font-bold">${p.images.length} Photos</div>
                    
                    <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="absolute bottom-3 left-3 z-30 p-2 rounded-full bg-brandGold text-brandBlue shadow-lg hover:scale-110 active:scale-95 transition-all opacity-0 group-hover:opacity-100 translate-y-4 group-hover:translate-y-0 duration-300 flex items-center gap-1 pr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <span class="text-[9px] font-black uppercase tracking-wider">Add</span>
                    </button>

                    ${p.inStock === false ? `
                    <div class="absolute inset-0 z-[25] flex flex-col items-center justify-center text-center p-4 transition-all duration-500">
                        <div class="border-2 border-brandGold/60 bg-black/40 px-4 py-2 rounded-2xl shadow-2xl">
                            <span class="block text-white text-xs md:text-base font-black uppercase tracking-widest mb-0.5 md:mb-1">Out of stock</span>
                            <span class="block text-brandGold text-[8px] md:text-[10px] font-bold font-arabic capitalize">غير متاح حاليا!</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="p-4 md:p-6 bg-white dark:bg-transparent overflow-hidden">
                    <div class="title-container mb-1">
                        <h3 class="title-slide text-sm md:text-xl font-black text-brandBlue dark:text-slate-100 uppercase">${p.name}</h3>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-brandGold/80 dark:text-brandGold/60 text-[10px] md:text-xs font-bold italic tracking-wide">View masterpiece <span class="group-hover:translate-x-1 inline-block transition-transform">→</span></p>
                        ${p.code ? `<span class="dc-price text-xs font-black text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded" data-code="${p.code}">...</span>` : ''}
                    </div>
                </div>
            `;

            // Quick Edit button for Staff
            if (userRole === 'admin' || userRole === 'moderator') {
                const editBtn = document.createElement('button');
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    window.editProduct(p.id);
                };
                editBtn.className = "absolute top-3 right-12 z-40 p-2 rounded-full bg-brandBlue/90 dark:bg-brandGold/90 text-white backdrop-blur-md shadow-lg hover:scale-110 active:scale-95 transition-all border border-white/20";
                editBtn.innerHTML = `
                    <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                `;
                editBtn.title = "Quick Edit";
                card.querySelector('.relative').appendChild(editBtn);
            }

            // Auto-slide logic
            let interval = null;
            let currentIdx = 0;
            const imgElement = card.querySelector('.product-card-img');
            const images = p.images && p.images.length > 0 ? p.images : [];

            if (images.length > 1) {
                const startSliding = () => {
                    if (interval) return;
                    interval = setInterval(() => {
                        currentIdx = (currentIdx + 1) % images.length;
                        imgElement.style.opacity = '0.7';
                        setTimeout(() => {
                            imgElement.src = images[currentIdx];
                            imgElement.style.opacity = '1';
                        }, 100);
                    }, 1200);
                };

                const stopSliding = () => {
                    if (interval) {
                        clearInterval(interval);
                        interval = null;
                        currentIdx = 0;
                        imgElement.src = images[0];
                        imgElement.style.opacity = '1';
                    }
                };

                card.addEventListener('mouseenter', startSliding);
                card.addEventListener('mouseleave', stopSliding);
                // Also support touch
                card.addEventListener('touchstart', startSliding, {passive: true});
                card.addEventListener('touchend', stopSliding, {passive: true});
            }

            return card;
        }

        searchInput.oninput = (e) => {
            searchQuery = e.target.value;
            renderProducts();
        };

        function initReveal() {
            const fabGroup = document.getElementById('floatingFabGroup');
            const reveals = document.querySelectorAll('.reveal');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) entry.target.classList.add('active');
                });
            }, { threshold: 0.1 });

            reveals.forEach(r => observer.observe(r));

            window.addEventListener('scroll', () => {
                const s = window.scrollY;
                if (s > 300) {
                    fabGroup.classList.remove('translate-y-20', 'opacity-0', 'invisible');
                    fabGroup.classList.add('translate-y-0', 'opacity-100', 'visible');
                } else {
                    fabGroup.classList.add('translate-y-20', 'opacity-0', 'invisible');
                    fabGroup.classList.remove('translate-y-0', 'opacity-100', 'visible');
                }
            });
        }

        let currentProduct = null;
        let currentImgIdx = 0;
        let currentVariantIdx = null; // Track selected variant
        let touchStartX = 0;
        let touchEndX = 0;

        window.showDetails = function(id) {
            currentProduct = products.find(prod => prod.id === id);
            if (!currentProduct) return;
            currentImgIdx = 0;
            currentVariantIdx = null; // Reset variant selection

            document.getElementById('detailTitle').innerText = currentProduct.name;
            document.getElementById('detailDesc').innerText = currentProduct.desc;
            
            // Show Live Price inside detail modal
            const priceSection = document.getElementById('detailPriceSection');
            priceSection.classList.add('hidden');
            const isRetailUser = (userRole === 'customer');
            const isWholesaleUser = (userRole === 'cst_wholesale');
            if (currentProduct.code && window._dcPriceMap) {
                const code = String(currentProduct.code).trim();
                const info = window._dcPriceMap[code];
                if (info) {
                    const retail = info.retail_price || info.sectorSalesPrice || info.sellingPrice || info.price || 0;
                    const disc = info.discount_amount || info.discount || 0;
                    const wholesale = info.wholesale_price || info.wholesalePrice || 0;
                    const pVal = parseFloat(retail) || 0;
                    const dVal = parseFloat(disc) || 0;
                    const net = (pVal - dVal).toFixed(2);
                    
                    // CST. Retail: hide Net, Discount, Wholesale → show only Retail (as "Price")
                    // CST. Wholesale: hide Retail, Discount → show only Net + Wholesale
                    // Admin/Moderator: show all
                    document.getElementById('detailNetPrice').parentElement.style.display = isRetailUser ? 'none' : '';
                    document.getElementById('detailDiscount').parentElement.style.display = (isRetailUser || isWholesaleUser) ? 'none' : '';
                    document.getElementById('detailWholesalePrice').parentElement.style.display = isRetailUser ? 'none' : '';
                    document.getElementById('detailRetailPriceWrap').style.display = isWholesaleUser ? 'none' : '';

                    // Hide the separator pipe for retail & wholesale
                    const priceSeparators = priceSection.querySelectorAll('span.text-gray-300');
                    priceSeparators.forEach(sep => sep.style.display = (isRetailUser || isWholesaleUser) ? 'none' : '');

                    // For CST. Retail: show retail price in green, no line-through
                    const retailPriceEl = document.getElementById('detailRetailPrice');
                    if (isRetailUser) {
                        retailPriceEl.className = 'text-lg font-black text-green-600';
                        document.getElementById('detailRetailPriceWrap').querySelector('span:first-child').innerHTML = 'Price<br>السعر';
                    } else {
                        retailPriceEl.className = 'text-sm font-bold text-gray-400 line-through';
                        document.getElementById('detailRetailPriceWrap').querySelector('span:first-child').innerHTML = 'Retail<br>العبوة';
                    }

                    document.getElementById('detailNetPrice').innerText = net + ' EGP';
                    document.getElementById('detailDiscount').innerText = disc;
                    document.getElementById('detailRetailPrice').innerText = retail + ' EGP';
                    document.getElementById('detailWholesalePrice').innerText = wholesale + ' EGP';
                    priceSection.classList.remove('hidden');
                }
            }

            // Show/hide retail Add to Cart button (for CST. Retail AND CST. Wholesale)
            const retailCartBtn = document.getElementById('detailRetailCartBtn');
            const retailCartOrderBtn = document.getElementById('retailCartOrderBtn');
            const hasPriceData = currentProduct.code && window._dcPriceMap && window._dcPriceMap[String(currentProduct.code).trim()];
            if (retailCartBtn) {
                if ((isRetailUser || isWholesaleUser) && hasPriceData) {
                    retailCartBtn.classList.remove('hidden');
                    const qtyInput = document.getElementById('retailQtyInput');
                    if (qtyInput) qtyInput.value = 1;
                    if (retailCartOrderBtn) {
                        retailCartOrderBtn.onclick = () => {
                            const qty = Math.max(1, parseInt(qtyInput?.value) || 1);
                            addToCart(currentProduct.id, currentVariantIdx, qty);
                            if (qtyInput) qtyInput.value = 1;
                            // Button press feedback
                            retailCartOrderBtn.classList.add('scale-95', 'brightness-110');
                            setTimeout(() => retailCartOrderBtn.classList.remove('scale-95', 'brightness-110'), 200);
                        };
                    }
                } else {
                    retailCartBtn.classList.add('hidden');
                }
            }

            // Show/hide wholesale button & wire onclick (hidden for CST. Retail)
            const wholesaleBtn = document.getElementById('detailWholesaleBtn');
            const wholesaleOrderBtn = document.getElementById('wholesaleOrderBtn');
            if (wholesaleBtn) {
                if (!isRetailUser && hasPriceData) {
                    wholesaleBtn.classList.remove('hidden');
                    if (wholesaleOrderBtn) {
                        wholesaleOrderBtn.onclick = () => {
                            const qtyInput = document.getElementById('wholesaleQtyInput');
                            const qty = Math.max(1, parseInt(qtyInput?.value) || 1);
                            addToWholesaleCart(currentProduct.id, currentVariantIdx, qty);
                            if (qtyInput) qtyInput.value = 1;
                        };
                    }
                } else {
                    wholesaleBtn.classList.add('hidden');
                }
            }
            
            // Handle Variants
            const vContainer = document.getElementById('detailVariants');
            vContainer.innerHTML = '';
            vContainer.classList.add('hidden');
            
            // Default Enquiry Message
            let message = `مرحباً ال عاشور عدس، أود الاستفسار عن منتج: ${currentProduct.name}\n\nالوصف:\n${currentProduct.desc}`;
            
            if (currentProduct.variants && currentProduct.variants.length > 0) {
                // Auto-select first in-stock variant if available
                const firstInStock = currentProduct.variants.findIndex(v => v.inStock);
                if (firstInStock !== -1) currentVariantIdx = firstInStock;

                vContainer.classList.remove('hidden');
                
                const title = document.createElement('p');
                title.className = 'text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider';
                title.innerText = 'Available Options:';
                vContainer.appendChild(title);

                const chipsContainer = document.createElement('div');
                chipsContainer.className = 'flex flex-wrap gap-2';
                vContainer.appendChild(chipsContainer);

                currentProduct.variants.forEach((v, idx) => {
                    const chip = document.createElement('button');
                    // Add distinct ID or data attribute for ease of selection
                    chip.dataset.vIdx = idx;
                    chip.className = `px-4 py-2 rounded-lg text-xs font-bold border transition-all flex items-center gap-2 bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:border-brandGold ${!v.inStock ? 'opacity-60' : ''}`;
                    
                    const dot = `<span class="w-2 h-2 rounded-full ${v.inStock ? 'bg-green-500' : 'bg-red-500'}"></span>`;
                    const nameSpan = `<span class="${v.inStock ? '' : 'line-through decoration-red-500/50'}">${v.name}</span>`;
                    chip.innerHTML = `${dot} ${nameSpan}`;
                    
                    if(!v.inStock) {
                        chip.title = "Currently Unavailable";
                    }

                    chip.onclick = () => {
                        currentVariantIdx = idx; // Update tracked variant
                        
                        // Update UI Highlight manually here to ensure immediate feedback
                        const all = chipsContainer.querySelectorAll('button');
                        all.forEach(b => b.classList.remove('ring-2', 'ring-brandGold', 'bg-brandGold/10'));
                        chip.classList.add('ring-2', 'ring-brandGold', 'bg-brandGold/10');

                        const vImgs = Array.isArray(v.images) ? v.images : (v.image ? [v.image] : []);
                        if (vImgs.length === 0) return;

                        // Try to find if any of the variant images are already in the gallery
                        let galleryIdx = -1;
                        for(const url of vImgs) {
                            const idx = currentProduct.images.indexOf(url);
                            if(idx !== -1) {
                                galleryIdx = idx;
                                break;
                            }
                        }

                        if (galleryIdx !== -1) {
                            // If found in gallery, treat it like a thumbnail click
                            updateDetailImage(galleryIdx);
                        } else {
                            // If NOT in gallery (custom upload), handle manual sync using first variant image
                            const firstImg = vImgs[0];
                            currentImgIdx = -1;
                            renderThumbnails(); 
                            // Warning: syncVariantHighlight might override our manual highlight if it doesn't match the image exactly
                            // So we rely on the click handler we just set.
                            
                            const img = document.getElementById('mainDetailImg');
                            img.style.opacity = '0';
                            setTimeout(() => {
                                img.src = firstImg;
                                img.style.opacity = '1';
                                isZoomed = false;
                                img.style.transform = 'scale(1)';
                                const tBar = document.getElementById('thumbnailBar');
                                if(tBar) tBar.classList.remove('opacity-0', 'pointer-events-none');
                            }, 150);
                        }
                    };
                    
                    chipsContainer.appendChild(chip);
                });
            }

            // Initial Render
            if (currentVariantIdx !== null) {
                // If we have a default variant, try to show its image
                const v = currentProduct.variants[currentVariantIdx];
                 const vImgs = Array.isArray(v.images) ? v.images : (v.image ? [v.image] : []);
                 if(vImgs.length > 0) {
                     // Try to match image in main gallery
                     const idx = currentProduct.images.indexOf(vImgs[0]);
                     if(idx !== -1) updateDetailImage(idx);
                     else updateDetailImage(0);
                 } else {
                     updateDetailImage(0);
                 }
                 // Highlight the chip
                 setTimeout(() => {
                    const chips = vContainer.querySelectorAll('button');
                    if(chips[currentVariantIdx]) chips[currentVariantIdx].classList.add('ring-2', 'ring-brandGold', 'bg-brandGold/10');
                 }, 50);
            } else {
                updateDetailImage(0);
            }
            
            updateModalFavBtn();

            renderThumbnails();

            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function updateModalFavBtn() {
            if (!currentProduct) return;
            const isFav = userFavorites.includes(currentProduct.id);
            const enquiryBtn = document.getElementById('enquiryBtn');
            const btnContainer = enquiryBtn.parentElement;
            
            // Update the fav button next to the title
            const detailFavBtn = document.getElementById('detailFavBtn');
            if (detailFavBtn) {
                detailFavBtn.classList.remove('hidden');
                detailFavBtn.className = `p-2 rounded-full hover:scale-110 active:scale-95 transition-all ${isFav ? 'text-red-500' : 'text-gray-400'}`;
                detailFavBtn.id = 'detailFavBtn';
            }

            // Remove existing buttons (edit, wholesale, cart)
            const oldEdit = btnContainer.querySelector('.modal-edit-btn');
            if(oldEdit) oldEdit.remove();
            const oldWholesale = btnContainer.querySelector('.modal-wholesale-btn');
            if(oldWholesale) oldWholesale.remove();
            const oldCart = btnContainer.querySelector('.modal-cart-btn');
            if(oldCart) oldCart.remove();

            // Create Edit Button for Admins/Moderators
            if (userRole === 'admin' || userRole === 'moderator') {
                const editBtn = document.createElement('button');
                editBtn.className = "modal-edit-btn p-3 md:p-4 rounded-xl bg-brandGold/10 hover:bg-brandGold/20 text-brandGold transition-all border border-brandGold/20 hover:scale-105 active:scale-95";
                editBtn.innerHTML = `
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                `;
                editBtn.title = "Edit Piece";
                editBtn.onclick = () => {
                    window.editProduct(currentProduct.id);
                };
                btnContainer.insertBefore(editBtn, enquiryBtn);
            }

            // Wholesale icon button - hidden for CST. Retail
            if (userRole !== 'customer') {
                const wholesaleBtn = document.createElement('button');
                wholesaleBtn.className = "modal-wholesale-btn p-3 md:p-4 rounded-xl bg-brandGold/10 text-brandGold transition-all border border-brandGold/30 hover:bg-brandGold hover:text-white hover:scale-105 active:scale-95";
                wholesaleBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                `;
                wholesaleBtn.title = "Add to Wholesale Cart";
                wholesaleBtn.onclick = () => {
                    addToWholesaleCart(currentProduct.id, currentVariantIdx);
                    setTimeout(() => openWholesaleCart(), 350);
                };
                btnContainer.insertBefore(wholesaleBtn, enquiryBtn);
            }
            
            // Cart icon button
            const cartBtn = document.createElement('button');
            cartBtn.className = "modal-cart-btn p-3 md:p-4 rounded-xl bg-brandBlue text-white transition-all border border-brandGold shadow-lg shadow-brandBlue/20 hover:scale-105 active:scale-95";
            cartBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
            `;
            cartBtn.title = "Add to Cart";
            cartBtn.onclick = () => {
                addToCart(currentProduct.id, currentVariantIdx);
                setTimeout(() => openCart(), 350);
            };

            btnContainer.className = "flex items-center space-x-3 mt-6 md:mt-10";
            enquiryBtn.classList.remove('w-full');
            enquiryBtn.classList.add('flex-1');
            
            // Order: Edit -> Wholesale -> Cart -> WhatsApp
            btnContainer.insertBefore(cartBtn, enquiryBtn);
        }

        let isZoomed = false;

        function updateDetailImage(idx) {
            if (!currentProduct || !currentProduct.images[idx]) return;
            currentImgIdx = idx;
            const img = document.getElementById('mainDetailImg');
            const targetSrc = currentProduct.images[idx];
            const tBar = document.getElementById('thumbnailBar');
            
            // Reset zoom
            isZoomed = false;
            img.style.transform = 'scale(1)';
            img.style.cursor = 'zoom-in';
            if(tBar) tBar.classList.remove('opacity-0', 'pointer-events-none');
            
            // 1. Sync Thumbnails immediately
            renderThumbnails();

            // 2. Sync Variant Selection immediately
            syncVariantHighlight(targetSrc);

            // 3. Update Main Image with transition
            img.style.opacity = '0';
            setTimeout(() => {
                img.src = targetSrc;
                img.style.opacity = '1';
            }, 150);
        }

        // Dedicated helper to sync variant chips based on an image URL
        function syncVariantHighlight(imageUrl) {
            const vContainer = document.getElementById('detailVariants');
            const chipsContainer = vContainer.querySelector('div.flex.flex-wrap');
            const overlay = document.getElementById('outOfStockOverlay');
            const mainImg = document.getElementById('mainDetailImg');
            
            // Reset state
            overlay.classList.add('opacity-0');
            overlay.classList.remove('opacity-100');
            mainImg.style.filter = 'none';

            // Global Out of Stock check
            const isGloballyOOS = currentProduct.inStock === false;
            // ... Logic kept, but removing auto-highlight reset if user manually selected ...
            // ACTUALLY: The image click might want to update the variant selection too?
            // User requirement is about adding to cart.
            // If user swipes image, should the variant change? 
            // Usually yes if that image belongs to a variant.

            if (isGloballyOOS) {
                overlay.classList.remove('opacity-0');
                overlay.classList.add('opacity-100');
            }

            if (!currentProduct.variants || currentProduct.variants.length === 0) {
                let msg = `مرحباً ال عاشور عدس، أود الاستفسار عن منتج: ${currentProduct.name}\n\nالوصف:\n${currentProduct.desc}`;
                if(isGloballyOOS) msg += "\n(Note: This product shows as currently out of stock)";
                document.getElementById('enquiryBtn').href = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(msg)}`;
                return;
            }
            
            if (!chipsContainer) return;

            const allChips = chipsContainer.querySelectorAll('button');
            let matched = false;
            let matchedIdx = -1;

            // Reset all chips visual only if we find a match via image
            // OR if the current variant selection is inconsistent with the image shown.
            
            // Default enquiry
            let message = `مرحباً ال عاشور عدس، أود الاستفسار عن منتج: ${currentProduct.name}\n\nالوصف:\n${currentProduct.desc}`;
            if(isGloballyOOS) message += "\n(Note: This product shows as currently out of stock)";

            // Find and highlight matching variant
            currentProduct.variants.forEach((v, vIdx) => {
                const vImgs = Array.isArray(v.images) ? v.images : (v.image ? [v.image] : []);
                const isMatch = vImgs.some(img => img === imageUrl || imageUrl.includes(img));

                if (isMatch && !matched) {
                    matched = true;
                    matchedIdx = vIdx;
                    
                    const chip = allChips[vIdx];
                    if (chip) {
                        // Reset others
                        allChips.forEach(c => c.classList.remove('ring-2', 'ring-brandGold', 'bg-brandGold/10'));
                        
                        chip.classList.add('ring-2', 'ring-brandGold', 'bg-brandGold/10');
                        message = `مرحباً ال عاشور عدس، أود الاستفسار عن منتج: ${currentProduct.name} (Option: ${v.name})\n\nالوصف:\n${currentProduct.desc}`;
                        
                        // Sync global state
                        currentVariantIdx = vIdx;

                        // Handle Variant-specific Out of Stock Visuals (if not already globally OOS)
                        if (!isGloballyOOS && !v.inStock) {
                            overlay.classList.remove('opacity-0');
                            overlay.classList.add('opacity-100');
                        }
                    }
                }
            });

            document.getElementById('enquiryBtn').href = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
        }

        function renderThumbnails() {
            const thumbBar = document.getElementById('thumbnailBar');
            if(!thumbBar) return;
            thumbBar.innerHTML = '';
            
            if(!currentProduct || !currentProduct.images) return;

            currentProduct.images.forEach((img, idx) => {
                if(!img) return; // Skip empty images
                const t = document.createElement('img');
                t.src = img;
                // Adjusted sizes for the floating bar
                t.className = `h-12 w-12 md:h-16 md:w-16 object-contain p-1 bg-white dark:bg-gray-800 rounded-lg md:rounded-xl cursor-pointer border-2 transition-all flex-shrink-0 ${idx === currentImgIdx ? 'border-brandGold scale-105 shadow-md' : 'border-transparent opacity-60 hover:opacity-100 hover:scale-105'}`;
                t.onclick = () => updateDetailImage(idx);
                thumbBar.appendChild(t);
            });
            // Auto scroll to active thumbnail
            const activeThumb = thumbBar.children[currentImgIdx];
            if (activeThumb) {
                activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        const swipeArea = document.getElementById('swipeArea');
        if (swipeArea) {
            swipeArea.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            swipeArea.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
        }

        function handleSwipe() {
            if (isZoomed) return; // Disable swipe when zoomed
            if (!currentProduct || currentProduct.images.length <= 1) return;
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) { // Threshold
                if (diff > 0) {
                    // Swipe left -> Next image
                    if (currentImgIdx < currentProduct.images.length - 1) {
                        updateDetailImage(currentImgIdx + 1);
                    }
                } else {
                    // Swipe right -> Prev image
                    if (currentImgIdx > 0) {
                        updateDetailImage(currentImgIdx - 1);
                    }
                }
            }
        }

        window.closeDetails = function() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
            // Reset zoom on close
            const img = document.getElementById('mainDetailImg');
            if(img) {
                isZoomed = false;
                img.style.transform = 'scale(1)';
            }
        }

        // Zoom Logic
        const mainImg = document.getElementById('mainDetailImg');
        const swipeContainer = document.getElementById('swipeArea');

        if (mainImg && swipeContainer) {
            mainImg.style.cursor = 'zoom-in';

            // Desktop: Mouse move to pan
            swipeContainer.addEventListener('mousemove', function(e) {
                if (isZoomed) {
                    const { left, top, width, height } = swipeContainer.getBoundingClientRect();
                    const x = ((e.clientX - left) / width) * 100;
                    const y = ((e.clientY - top) / height) * 100;
                    mainImg.style.transformOrigin = `${x}% ${y}%`;
                }
            });

            // Mobile: Touch move to pan
            swipeContainer.addEventListener('touchmove', function(e) {
                if (isZoomed && e.touches.length === 1) {
                    const touch = e.touches[0];
                    const { left, top, width, height } = swipeContainer.getBoundingClientRect();
                    const x = ((touch.clientX - left) / width) * 100;
                    const y = ((touch.clientY - top) / height) * 100;
                    
                    // Clamp values to keep it within image
                    const clampedX = Math.max(0, Math.min(100, x));
                    const clampedY = Math.max(0, Math.min(100, y));
                    
                    mainImg.style.transformOrigin = `${clampedX}% ${clampedY}%`;
                    if (e.cancelable) e.preventDefault();
                }
            }, { passive: false });

            // Click to toggle zoom
            mainImg.addEventListener('click', function(e) {
                e.stopPropagation();
                const tBar = document.getElementById('thumbnailBar');
                if (isZoomed) {
                    isZoomed = false;
                    mainImg.style.transform = "scale(1)";
                    mainImg.style.cursor = "zoom-in";
                    mainImg.classList.add('transition-transform');
                    mainImg.classList.add('duration-300');
                    if(tBar) tBar.classList.remove('opacity-0', 'pointer-events-none');
                    setTimeout(() => {
                        if(!isZoomed) mainImg.style.transformOrigin = "center center"; 
                    }, 300);
                } else {
                    isZoomed = true;
                    // Disable transition while zooming for smooth panning
                    mainImg.classList.remove('transition-transform');
                    mainImg.classList.remove('duration-300');
                    
                    mainImg.style.transform = "scale(3)";
                    mainImg.style.cursor = "zoom-out";
                    if(tBar) tBar.classList.add('opacity-0', 'pointer-events-none');
                    
                    const rect = swipeContainer.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 100;
                    const y = ((e.clientY - rect.top) / rect.height) * 100;
                    mainImg.style.transformOrigin = `${x}% ${y}%`;
                }
            });
        }

        window.toggleDarkMode = function() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            
            const isAutoEnabled = localStorage.getItem('autoThemeEnabled') !== 'false';
            if (isAutoEnabled) {
                localStorage.setItem('themeOverrideTime', Date.now());
                if (window._themeResetTimer) clearTimeout(window._themeResetTimer);
                window._themeResetTimer = setTimeout(() => {
                    localStorage.removeItem('darkMode');
                    localStorage.removeItem('themeOverrideTime');
                    applySmartTheme();
                }, 600000); 
            }

            // Expand the toggle briefly on desktop so the label appears for 3s
            const toggleEl = document.getElementById('darkToggle');
            if (!toggleEl) return;
            const isDesktop = window.matchMedia('(min-width: 769px)').matches;
            if (isDesktop) {
                if (window._darkToggleTimer) clearTimeout(window._darkToggleTimer);
                toggleEl.classList.add('expanded');
                window._darkToggleTimer = setTimeout(() => {
                    toggleEl.classList.remove('expanded');
                }, 3000);
            } else {
                toggleEl.classList.remove('expanded');
            }
        }

        // Ensure toggle is compact on initial load (remove expanded state)
        document.addEventListener('DOMContentLoaded', () => {
            const toggleEl = document.getElementById('darkToggle');
            if (toggleEl) toggleEl.classList.remove('expanded');
        });

        loadData();
        
        // Safety Timeout to handle hanging loads
        setTimeout(() => {
            const skeleton = document.querySelector('.loading-skeleton');
            if(skeleton) {
                skeleton.innerHTML = `
                    <div class="text-center p-8 bg-white/5 rounded-xl border border-red-500/30">
                         <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                         <p class="text-gray-400 mb-2 font-bold uppercase tracking-widest text-xs">Connection is taking too long...</p>
                         <p class="text-brandGold mb-6 font-bold font-arabic">الاتصال يستغرق وقتًا طويلاً...</p>
                         <button onclick="window.location.reload()" class="bg-brandGold text-white px-6 py-2 rounded-lg font-bold hover:bg-opacity-90 transition-opacity uppercase tracking-widest text-xs">Reload Page | إعادة تحميل</button>
                    </div>
                `;
            }
        }, 12000); // 12 seconds timeout

        // --- Shopping Cart Logic ---
        let cart = JSON.parse(localStorage.getItem('houseOfGlassCart')) || [];

        window.addToCart = function(productId, variantIdx = null, qty = 1) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            qty = Math.max(1, qty);

            // Handle Variant
            let variant = null;
            if (variantIdx !== null && product.variants && product.variants[variantIdx]) {
                variant = product.variants[variantIdx];
            } else if (product.variants && product.variants.length > 0 && variantIdx === null) {
                variant = product.variants[0];
            }
            
            // Check stock
            if (product.inStock === false) {
                 window.showToast("Product is out of stock", "error");
                 return;
            }
            if (variant && variant.inStock === false) {
                window.showToast(`Selected option (${variant.name}) is out of stock`, "error");
                return;
            }
            
            // Generate a unique ID for cart item (combining product ID + variant name)
            const cartItemId = variant ? `${product.id}-${variant.name.replace(/\s+/g, '_')}` : product.id;
            
            const existingItem = cart.find(item => item.cartId === cartItemId);
            
            if (existingItem) {
                existingItem.quantity += qty;
                window.showToast(qty > 1 ? `${qty} added to cart!` : "Quantity updated in cart!");
            } else {
                // Get live price from DC system
                let itemPrice = 0;
                if (product.code && window._dcPriceMap) {
                    const code = String(product.code).trim();
                    const info = window._dcPriceMap[code];
                    if (info) {
                        itemPrice = parseFloat(info.retail_price || info.sectorSalesPrice || info.sellingPrice || info.price || 0);
                    }
                }

                cart.push({
                    cartId: cartItemId,
                    productId: product.id,
                    name: product.name,
                    price: itemPrice, 
                    image: variant && (variant.image || (variant.images && variant.images[0])) ? (variant.image || variant.images[0]) : (product.images[0] || ''),
                    variantName: variant ? variant.name : null,
                    quantity: qty,
                    addedAt: Date.now()
                });
                window.showToast(qty > 1 ? `${qty} added to cart!` : "Added to cart!");
            }
            
            saveCart();
            updateCartUI();
        };

        window.removeFromCart = function(index) {
            cart.splice(index, 1);
            saveCart();
            updateCartUI();
        };

        window.updateCartQuantity = function(index, change) {
            if (cart[index]) {
                cart[index].quantity += change;
                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1);
                }
                saveCart();
                updateCartUI();
            }
        };

        function saveCart() {
            localStorage.setItem('houseOfGlassCart', JSON.stringify(cart));
        }

        window.openCart = function() {
            updateCartUI();
            document.getElementById('cartModal').classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        };

        window.closeCart = function() {
            document.getElementById('cartModal').classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        };

        function updateCartUI() {
            // Update Badge
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cartCount');
            if (badge) {
                badge.innerText = count;
                if (count > 0) {
                    badge.classList.remove('opacity-0', 'scale-0');
                    badge.classList.add('bg-red-500'); // Ensure color
                } else {
                    badge.classList.add('opacity-0', 'scale-0');
                }
            }
            
            if(document.getElementById('cartTotalItems')) {
                document.getElementById('cartTotalItems').innerText = `${count} Items | عبوة`;
            }

            // Count unique categories (products/asnaf)
            const uniqueProducts = new Set(cart.map(item => item.productId));
            const catCountEl = document.getElementById('cartCategoryCount');
            if (catCountEl) {
                catCountEl.innerText = `${uniqueProducts.size} Category | صنف`;
            }

            // Update List
            const list = document.getElementById('cartItemsList');
            if (!list) return;

            if (cart.length === 0) {
                list.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 text-gray-400 opacity-60">
                    <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <p class="font-bold uppercase tracking-widest">Your cart is empty</p>
                </div>`;
                document.getElementById('checkoutBtn').disabled = true;
                const emptyTotal = document.getElementById('cartTotalSection');
                if (emptyTotal) emptyTotal.classList.add('hidden');
                const emptyPrice = document.getElementById('cartTotalPrice');
                if (emptyPrice) emptyPrice.textContent = '0.00 EGP';
                return;
            }

            document.getElementById('checkoutBtn').disabled = false;
            list.innerHTML = '';
            
            // 1. Group items by productId
            const grouped = {};
            cart.forEach((item, originalIdx) => {
                if (!grouped[item.productId]) {
                    grouped[item.productId] = {
                        info: item,
                        variants: []
                    };
                }
                grouped[item.productId].variants.push({ ...item, originalIdx });
            });

            // 2. Render each group as one card
            Object.values(grouped).forEach(group => {
                const mainItem = group.info;
                const div = document.createElement('div');
                div.className = 'bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-brandGold/20 shadow-[0_2px_12px_rgba(196,164,81,0.15)]';
                
                // Build variants list HTML
                const isRetailCartUser = (userRole === 'customer');
                const isWholesaleCartUser = (userRole === 'cst_wholesale');
                const variantsHtml = group.variants.map(v => {
                    const lineTotal = (v.price * v.quantity).toFixed(2);
                    
                    // Lookup discount from DC
                    const prod = products.find(p => p.id === v.productId);
                    let discount = 0;
                    let netPrice = v.price;
                    let wholesale = 0;
                    if (prod && prod.code && window._dcPriceMap) {
                        const info = window._dcPriceMap[String(prod.code).trim()];
                        if (info) {
                            discount = parseFloat(info.discount_amount || info.discount || 0);
                            netPrice = v.price - discount;
                            wholesale = parseFloat(info.wholesale_price || info.wholesalePrice || 0);
                        }
                    }
                    const netLineTotal = (netPrice * v.quantity).toFixed(2);

                    // Build price columns based on role
                    let priceColumnsHtml = '';
                    if (isRetailCartUser) {
                        // CST. Retail: Price | السعر with green total
                        priceColumnsHtml = `<div class="flex flex-col flex-1">
                                <span class="text-[8px] text-brandGold uppercase font-bold">Price | السعر</span>
                                <span class="text-sm font-black text-green-600">${v.quantity > 1 ? `<span class="text-brandGold">${v.price.toFixed(2)}</span> <span class="text-brandBlue dark:text-white">×</span> <span class="text-brandGold">${v.quantity}</span> <span class="text-brandBlue dark:text-white">=</span> ${lineTotal} EGP` : `${lineTotal} EGP`}</span>
                            </div>`;
                    } else if (isWholesaleCartUser) {
                        // CST. Wholesale: Pack. Price only (wholesale goes in wholesale cart)
                        priceColumnsHtml = `<div class="flex flex-col flex-1">
                                <span class="text-[8px] text-green-500 uppercase font-bold">Pack. Price | سعر العبوة</span>
                                <span class="text-sm font-black text-green-600">${v.quantity > 1 ? `<span class="text-green-600">${netPrice.toFixed(2)}</span> <span class="text-brandBlue dark:text-white">×</span> <span class="text-green-600">${v.quantity}</span> <span class="text-brandBlue dark:text-white">=</span> ${netLineTotal} EGP` : `${netLineTotal} EGP`}</span>
                            </div>`;
                    } else {
                        // Admin/Moderator: show all
                        priceColumnsHtml = `<div class="flex flex-col">
                                <span class="text-[8px] text-gray-400 uppercase font-bold">Pack. Price | سعر العبوة</span>
                                <span class="text-sm font-black text-green-600">${netLineTotal} EGP</span>
                            </div>
                            <span class="text-gray-300 dark:text-gray-600 font-light">|</span>
                            <div class="flex flex-col">
                                <span class="text-[8px] text-gray-400 uppercase font-bold">Discount</span>
                                <span class="text-sm font-black text-red-500">${discount}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[8px] text-gray-400 uppercase font-bold">Retail</span>
                                <span class="text-sm font-bold text-gray-500">${lineTotal} EGP</span>
                            </div>
                            <div class="flex flex-col text-right">
                                <span class="text-[8px] text-gray-400 uppercase font-bold">Wholesale</span>
                                <span class="text-sm font-bold text-brandGold">${(wholesale * v.quantity).toFixed(2)} EGP</span>
                            </div>`;
                    }

                    return `
                    <div class="mt-3 pl-2 border-l-2 border-brandGold/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] md:text-xs text-gray-500 dark:text-white font-black uppercase tracking-widest">${v.variantName || 'Standard'}</span>
                            <div class="flex items-center gap-3">
                                <div class="flex items-center bg-white dark:bg-gray-800 rounded-lg border dark:border-gray-600 scale-90 origin-right">
                                    <button onclick="updateCartQuantity(${v.originalIdx}, -1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-brandBlue font-bold">-</button>
                                    <span class="text-xs font-bold w-4 text-center dark:text-white">${v.quantity}</span>
                                    <button onclick="updateCartQuantity(${v.originalIdx}, 1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-brandBlue font-bold">+</button>
                                </div>
                                <button onclick="removeFromCart(${v.originalIdx})" class="text-xs text-red-400 hover:text-red-500">✕</button>
                            </div>
                        </div>
                        ${v.price > 0 ? `
                        <div class="flex items-center justify-between gap-4 p-2 rounded-lg bg-white/50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-700">
                            ${priceColumnsHtml}
                        </div>
                        ` : ''}
                    </div>
                `;
                }).join('');

                div.innerHTML = `
                    <div class="flex items-start gap-4 mb-2">
                        <div class="w-16 h-16 bg-white dark:bg-gray-700 rounded-lg p-2 flex-shrink-0 border dark:border-gray-600">
                            <img src="${mainItem.image}" class="w-full h-full object-contain">
                        </div>
                        <div class="flex-grow pt-1">
                            <h4 class="font-black text-brandBlue dark:text-brandGold text-sm md:text-base leading-tight">${mainItem.name}</h4>
                            <p class="text-[9px] text-gray-400 uppercase tracking-widest mt-1">${group.variants.length} Option${group.variants.length > 1 ? 's' : ''} Selected</p>
                        </div>
                    </div>
                    
                    <div class="space-y-1">
                        ${variantsHtml}
                    </div>
                `;
                list.appendChild(div);
            });

            // Calculate and display total
            const totalSection = document.getElementById('cartTotalSection');
            const totalPriceEl = document.getElementById('cartTotalPrice');
            if (totalSection && totalPriceEl) {
                let retailTotal = 0;
                let netTotal = 0;
                cart.forEach(item => {
                    retailTotal += item.price * item.quantity;
                    let disc = 0;
                    const prod = products.find(p => p.id === item.productId);
                    if (prod && prod.code && window._dcPriceMap) {
                        const info = window._dcPriceMap[String(prod.code).trim()];
                        if (info) disc = parseFloat(info.discount_amount || info.discount || 0);
                    }
                    netTotal += (item.price - disc) * item.quantity;
                });
                if (retailTotal > 0) {
                    if (userRole === 'customer') {
                        // CST. Retail: show only retail total in green
                        totalPriceEl.innerHTML = `<span class="text-green-600">${retailTotal.toFixed(2)} EGP</span>`;
                    } else if (userRole === 'cst_wholesale') {
                        // CST. Wholesale: show pack price total in green
                        totalPriceEl.innerHTML = `<span class="text-green-600">${netTotal.toFixed(2)} EGP</span>`;
                    } else {
                        const saved = retailTotal - netTotal;
                        totalPriceEl.innerHTML = saved > 0
                            ? `<span class="text-sm text-gray-400 mr-2">${retailTotal.toFixed(2)}</span> ${netTotal.toFixed(2)} EGP <span class="text-red-500 text-sm font-bold ml-2">-${saved.toFixed(2)}</span>`
                            : `${retailTotal.toFixed(2)} EGP`;
                    }
                    totalSection.classList.remove('hidden');
                } else {
                    totalSection.classList.add('hidden');
                }
            }
        }

        // Initialize Cart UI on load
        updateCartUI();

        // --- Wholesale Cart Logic ---
        let wholesaleCart = JSON.parse(localStorage.getItem('houseOfGlassWholesaleCart')) || [];

        window.addToWholesaleCart = function(productId, variantIdx = null, qty = 1) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            let variant = null;
            if (variantIdx !== null && product.variants && product.variants[variantIdx]) {
                variant = product.variants[variantIdx];
            } else if (product.variants && product.variants.length > 0 && variantIdx === null) {
                variant = product.variants[0];
            }

            if (product.inStock === false) {
                window.showToast("Product is out of stock", "error");
                return;
            }
            if (variant && variant.inStock === false) {
                window.showToast(`Selected option (${variant.name}) is out of stock`, "error");
                return;
            }

            const cartItemId = variant ? `${product.id}-${variant.name.replace(/\s+/g, '_')}` : product.id;
            const existingItem = wholesaleCart.find(item => item.cartId === cartItemId);

            if (existingItem) {
                existingItem.quantity += qty;
                window.showToast(`Quantity updated to ${existingItem.quantity} in wholesale order!`, "success");
            } else {
                let itemPrice = 0;
                if (product.code && window._dcPriceMap) {
                    const code = String(product.code).trim();
                    const info = window._dcPriceMap[code];
                    if (info) {
                        itemPrice = parseFloat(info.wholesale_price || info.wholesalePrice || 0);
                    }
                }

                wholesaleCart.push({
                    cartId: cartItemId,
                    productId: product.id,
                    name: product.name,
                    price: itemPrice,
                    image: variant && (variant.image || (variant.images && variant.images[0])) ? (variant.image || variant.images[0]) : (product.images[0] || ''),
                    variantName: variant ? variant.name : null,
                    quantity: qty,
                    addedAt: Date.now()
                });
                window.showToast(`Added ${qty} to wholesale order!`, "success");
            }

            saveWholesaleCart();
            updateWholesaleCartUI();
        };

        window.removeFromWholesaleCart = function(index) {
            wholesaleCart.splice(index, 1);
            saveWholesaleCart();
            updateWholesaleCartUI();
        };

        window.updateWholesaleCartQuantity = function(index, change) {
            if (wholesaleCart[index]) {
                wholesaleCart[index].quantity += change;
                if (wholesaleCart[index].quantity <= 0) {
                    wholesaleCart.splice(index, 1);
                }
                saveWholesaleCart();
                updateWholesaleCartUI();
            }
        };

        function saveWholesaleCart() {
            localStorage.setItem('houseOfGlassWholesaleCart', JSON.stringify(wholesaleCart));
        }

        window.openWholesaleCart = function() {
            if (userRole === 'customer') return; // CST. Retail cannot access wholesale cart
            updateWholesaleCartUI();
            document.getElementById('wholesaleCartModal').classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        };

        window.closeWholesaleCart = function() {
            document.getElementById('wholesaleCartModal').classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        };

        function updateWholesaleCartUI() {
            const count = wholesaleCart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('wholesaleCartCount');
            if (badge) {
                badge.innerText = count;
                if (count > 0) {
                    badge.classList.remove('opacity-0', 'scale-0');
                } else {
                    badge.classList.add('opacity-0', 'scale-0');
                }
            }

            if (document.getElementById('wholesaleCartTotalItems')) {
                document.getElementById('wholesaleCartTotalItems').innerText = `${count} Items`;
            }

            const list = document.getElementById('wholesaleCartItemsList');
            if (!list) return;

            if (wholesaleCart.length === 0) {
                list.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 text-gray-400 opacity-60">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <p class="font-bold uppercase tracking-widest">No wholesale items</p>
                </div>`;
                document.getElementById('wholesaleCheckoutBtn').disabled = true;
                const emptyWTotal = document.getElementById('wholesaleCartTotalSection');
                if (emptyWTotal) emptyWTotal.classList.add('hidden');
                const emptyWPrice = document.getElementById('wholesaleCartTotalPrice');
                if (emptyWPrice) emptyWPrice.textContent = '0.00 EGP';
                return;
            }

            document.getElementById('wholesaleCheckoutBtn').disabled = false;
            list.innerHTML = '';

            const grouped = {};
            wholesaleCart.forEach((item, originalIdx) => {
                if (!grouped[item.productId]) {
                    grouped[item.productId] = { info: item, variants: [] };
                }
                grouped[item.productId].variants.push({ ...item, originalIdx });
            });

            Object.values(grouped).forEach(group => {
                const mainItem = group.info;
                const div = document.createElement('div');
                div.className = 'bg-brandGold/5 dark:bg-brandGold/10 p-4 rounded-xl border border-brandGold/20';

                const variantsHtml = group.variants.map(v => {
                    const lineTotal = (v.price * v.quantity).toFixed(2);
                    return `
                    <div class="mt-3 pl-2 border-l-2 border-brandGold/30">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] md:text-xs text-gray-500 font-black uppercase tracking-widest">${v.variantName || 'Standard'}</span>
                            <div class="flex items-center gap-3">
                                <div class="flex items-center bg-white dark:bg-gray-800 rounded-lg border dark:border-gray-600 scale-90 origin-right">
                                    <button onclick="updateWholesaleCartQuantity(${v.originalIdx}, -1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-brandGold font-bold">-</button>
                                    <span class="text-xs font-bold w-4 text-center dark:text-white">${v.quantity}</span>
                                    <button onclick="updateWholesaleCartQuantity(${v.originalIdx}, 1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-brandGold font-bold">+</button>
                                </div>
                                <button onclick="removeFromWholesaleCart(${v.originalIdx})" class="text-xs text-red-400 hover:text-red-500">✕</button>
                            </div>
                        </div>
                        ${v.price > 0 ? `
                        <div class="flex items-center justify-between gap-4 p-2 rounded-lg bg-white/50 dark:bg-gray-800/50 border border-brandGold/20">
                            <div class="flex flex-col flex-1">
                                <span class="text-[8px] text-brandGold uppercase font-bold">Wholesale | \u0627\u0644\u0643\u0631\u062a\u0648\u0646\u0629</span>
                                <span class="text-sm font-black text-brandGold">${v.quantity > 1 ? `${v.price.toFixed(2)} \u00d7 ${v.quantity} = ${lineTotal} EGP` : `${lineTotal} EGP`}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>`;
                }).join('');

                div.innerHTML = `
                    <div class="flex items-start gap-4 mb-2">
                        <div class="w-16 h-16 bg-white dark:bg-gray-700 rounded-lg p-2 flex-shrink-0 border border-brandGold/20">
                            <img src="${mainItem.image}" class="w-full h-full object-contain">
                        </div>
                        <div class="flex-grow pt-1">
                            <h4 class="font-black text-brandGold text-sm md:text-base leading-tight">${mainItem.name}</h4>
                            <p class="text-[9px] text-gray-400 uppercase tracking-widest mt-1">${group.variants.length} Option${group.variants.length > 1 ? 's' : ''} Selected</p>
                        </div>
                    </div>
                    <div class="space-y-1">${variantsHtml}</div>
                `;
                list.appendChild(div);
            });

            // Calculate wholesale total
            const totalSection = document.getElementById('wholesaleCartTotalSection');
            const totalPriceEl = document.getElementById('wholesaleCartTotalPrice');
            if (totalSection && totalPriceEl) {
                let total = 0;
                wholesaleCart.forEach(item => { total += item.price * item.quantity; });
                if (total > 0) {
                    totalPriceEl.textContent = `${total.toFixed(2)} EGP`;
                    totalSection.classList.remove('hidden');
                } else {
                    totalSection.classList.add('hidden');
                }
            }
        }

        updateWholesaleCartUI();

        window.wholesaleCheckout = async function() {
            const btn = document.getElementById('wholesaleCheckoutBtn');
            const originalText = btn.innerHTML;

            if (wholesaleCart.length === 0) return;

            const orderData = {
                customer: currentUser ? {
                    uid: currentUser.uid,
                    name: currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'Guest'),
                    email: currentUser.email,
                } : { name: "Guest User" },
                items: wholesaleCart.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    variant: item.variantName,
                    quantity: item.quantity,
                    wholesalePrice: item.price,
                    image: item.image
                })),
                orderDate: new Date().toISOString(),
                source: "Gallery Website",
                orderType: "wholesale",
                status: "pending"
            };

            // Fetch user phone & role from Firestore
            if (currentUser) {
                try {
                    const uDoc = await getDoc(doc(db, "users", currentUser.uid));
                    if (uDoc.exists()) {
                        const ud = uDoc.data();
                        orderData.customer.phone = ud.phone || '';
                        orderData.customer.role = ud.role || 'customer';
                        orderData.customer.name = ud.name || orderData.customer.name;
                    }
                } catch(e) { console.warn("Could not fetch user details for order", e); }
            }

            if (!await showCheckoutConfirm({
                title: 'Wholesale Checkout | \u0625\u062a\u0645\u0627\u0645 \u0637\u0644\u0628 \u0627\u0644\u062c\u0645\u0644\u0629',
                message: 'This will send your wholesale order to our system.\n\u0633\u064a\u062a\u0645 \u0625\u0631\u0633\u0627\u0644 \u0637\u0644\u0628 \u0627\u0644\u062c\u0645\u0644\u0629 \u0627\u0644\u062e\u0627\u0635 \u0628\u0643 \u0625\u0644\u0649 \u0627\u0644\u0646\u0638\u0627\u0645.',
                type: 'wholesale'
            })) return;

            btn.disabled = true;
            btn.innerHTML = `<span class="animate-pulse">Processing...</span>`;

            try {
                // Save order to Firestore
                await addDoc(collection(db, "orders"), orderData);
                console.log("Wholesale Order saved to Firestore:", orderData);

                window.showToast("Wholesale order placed successfully!");
                wholesaleCart = [];
                saveWholesaleCart();
                updateWholesaleCartUI();
                closeWholesaleCart();
            } catch (error) {
                console.error("Wholesale Checkout Error:", error);
                window.showToast("Failed to place wholesale order. Please try again.", "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // --- Checkout & HG System Integration ---
        window.checkout = async function() {
            const btn = document.getElementById('checkoutBtn');
            const originalText = btn.innerHTML;
            
            if (cart.length === 0) return;

            // If user is not logged in, redirect to login page
            if (!currentUser) {
                localStorage.setItem('pendingCheckout', 'true');
                closeCart();
                window.location.href = 'login.html?redirect=checkout';
                return;
            }
            
            // 1. Gather Order Data
            // We need Customer Info. If logged in, use that. If not, maybe ask? 
            // For now, let's assume we send anonymous or logged in user data.
            
            // NOTE: Replace with your actual HG System API Key and URL
            const HG_API_KEY = "YOUR_HG_SYSTEM_API_KEY"; 
            const HG_API_URL = "https://your-hg-system-url.com/api/orders"; // PLACEHOLDER

            const orderData = {
                customer: currentUser ? {
                    uid: currentUser.uid,
                    name: currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'Guest'),
                    email: currentUser.email,
                } : { name: "Guest User" },
                items: cart.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    variant: item.variantName,
                    quantity: item.quantity,
                    price: item.price,
                    image: item.image
                })),
                orderDate: new Date().toISOString(),
                source: "Gallery Website",
                orderType: "retail",
                status: "pending"
            };

            // Fetch user phone & role from Firestore
            if (currentUser) {
                try {
                    const uDoc = await getDoc(doc(db, "users", currentUser.uid));
                    if (uDoc.exists()) {
                        const ud = uDoc.data();
                        orderData.customer.phone = ud.phone || '';
                        orderData.customer.role = ud.role || 'customer';
                        orderData.customer.name = ud.name || orderData.customer.name;
                    }
                } catch(e) { console.warn("Could not fetch user details for order", e); }
            }

            if (!await showCheckoutConfirm({
                title: 'Checkout | \u0625\u062a\u0645\u0627\u0645 \u0627\u0644\u0637\u0644\u0628',
                message: 'This will send your order to our system.\n\u0633\u064a\u062a\u0645 \u0625\u0631\u0633\u0627\u0644 \u0637\u0644\u0628\u0643 \u0625\u0644\u0649 \u0627\u0644\u0646\u0638\u0627\u0645.',
                type: 'retail'
            })) return;

            btn.disabled = true;
            btn.innerHTML = `<span class="animate-pulse">Processing...</span>`;

            try {
                // Save order to Firestore
                await addDoc(collection(db, "orders"), orderData);
                console.log("Retail Order saved to Firestore:", orderData);
                
                // Success
                window.showToast("Order placed successfully! We have received your invoice.");
                cart = []; // Clear cart
                saveCart();
                updateCartUI();
                closeCart();

            } catch (error) {
                console.error("Checkout Error:", error);
                window.showToast("Failed to place order. Please try again.", "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // 📽️ Cinematic Auto-Scroll Controller
        let activeAutoScrolls = new Map();

        function initRowAutoScroll() {
            // Cancel current animations if any
            activeAutoScrolls.forEach((id) => cancelAnimationFrame(id));
            activeAutoScrolls.clear();

            const rows = document.querySelectorAll('.category-row-container');
            if (!rows.length) return;

            rows.forEach(row => {
                let isPaused = false;
                let scrollSpeed = 0.5; // Cinematic speed (pixels per frame)
                const computedGap = parseFloat(window.getComputedStyle(row).gap) || 24; // Calculate gap once
                
                const setPause = (val) => isPaused = val;
                
                row.addEventListener('mouseenter', () => setPause(true));
                row.addEventListener('mouseleave', () => setPause(false));
                row.addEventListener('touchstart', () => setPause(true), {passive: true});
                row.addEventListener('touchend', () => {
                    setTimeout(() => setPause(false), 2000); // Resume after 2s of no touch
                }, {passive: true});

                function step() {
                    // Check minimum items requirement
                    const isMobile = window.innerWidth < 768;
                    const minItems = isMobile ? 1 : 3;
                    if (row.children.length <= minItems) {
                        const animId = requestAnimationFrame(step);
                        activeAutoScrolls.set(row.id, animId);
                        return;
                    }

                    row.style.scrollBehavior = 'auto';

                    // --- Seamless Infinite Loop Logic (Recycling) ---
                    // Forward: recycle first item to end
                    const firstChild = row.firstElementChild;
                    if (firstChild) {
                        const style = window.getComputedStyle(firstChild);
                        const margin = parseFloat(style.marginLeft || 0) + parseFloat(style.marginRight || 0);
                        const itemWidth = firstChild.offsetWidth + margin + computedGap;
                        
                        const maxScroll = row.scrollWidth - row.clientWidth;
                        
                        // Trigger recycling
                        if (row.scrollLeft >= itemWidth) {
                            row.appendChild(firstChild);
                            row.scrollLeft -= itemWidth;
                        } else if (maxScroll > 0 && row.scrollLeft >= maxScroll - 1) {
                            row.appendChild(firstChild);
                            row.scrollLeft = Math.max(0, row.scrollLeft - itemWidth);
                        }
                    }

                    // Backward: recycle last item to front
                    if (row.scrollLeft <= 2) {
                        const lastChild = row.lastElementChild;
                        if (lastChild) {
                            const style = window.getComputedStyle(lastChild);
                            const margin = parseFloat(style.marginLeft || 0) + parseFloat(style.marginRight || 0);
                            const lastWidth = lastChild.offsetWidth + margin + computedGap;
                            row.prepend(lastChild);
                            row.scrollLeft += lastWidth;
                        }
                    }

                    // --- Auto-scroll increment (only when NOT paused) ---
                    if (!isPaused && !row.dataset.manualScrolling) {
                        row.scrollLeft += scrollSpeed;
                    }
                    const animId = requestAnimationFrame(step);
                    activeAutoScrolls.set(row.id, animId);
                }
                
                const animId = requestAnimationFrame(step);
                activeAutoScrolls.set(row.id, animId);
            });
        }
    </script>

    <!-- Checkout Confirmation Modal -->
    <div id="checkoutConfirmModal" class="fixed inset-0 z-[200] flex items-center justify-center opacity-0 pointer-events-none transition-all duration-300">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="resolveCheckoutConfirm(false)"></div>
        <div id="checkoutConfirmContent" class="relative bg-white dark:bg-[#111827] rounded-2xl shadow-2xl w-11/12 max-w-md p-6 transform scale-95 transition-all duration-300 border border-gray-200 dark:border-gray-700">
            <div class="flex flex-col items-center text-center">
                <div id="checkoutConfirmIcon" class="w-16 h-16 rounded-full flex items-center justify-center mb-4"></div>
                <h3 id="checkoutConfirmTitle" class="text-lg font-black text-gray-900 dark:text-white uppercase tracking-tight mb-2"></h3>
                <p id="checkoutConfirmMsg" class="text-sm text-gray-500 dark:text-gray-400 mb-6 whitespace-pre-line"></p>
                <div class="flex gap-3 w-full">
                    <button onclick="resolveCheckoutConfirm(false)" class="flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest bg-gray-100 dark:bg-gray-800 text-gray-500 border border-gray-200 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">Cancel | إلغاء</button>
                    <button id="checkoutConfirmOk" onclick="resolveCheckoutConfirm(true)" class="flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest transition-all"></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let checkoutConfirmResolver = null;

        function showCheckoutConfirm({ title, message, type = 'wholesale' }) {
            return new Promise(resolve => {
                checkoutConfirmResolver = resolve;
                const modal = document.getElementById('checkoutConfirmModal');
                const content = document.getElementById('checkoutConfirmContent');
                const icon = document.getElementById('checkoutConfirmIcon');
                const titleEl = document.getElementById('checkoutConfirmTitle');
                const msgEl = document.getElementById('checkoutConfirmMsg');
                const okBtn = document.getElementById('checkoutConfirmOk');

                titleEl.textContent = title;
                msgEl.textContent = message;

                if (type === 'wholesale') {
                    icon.className = 'w-16 h-16 rounded-full flex items-center justify-center mb-4 bg-brandGold/10';
                    icon.innerHTML = '<svg class="w-8 h-8 text-brandGold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>';
                    okBtn.className = 'flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest bg-brandGold text-white hover:bg-brandGold/80 transition-all';
                    okBtn.textContent = 'Confirm | \u062a\u0623\u0643\u064a\u062f';
                } else {
                    icon.className = 'w-16 h-16 rounded-full flex items-center justify-center mb-4 bg-green-500/10';
                    icon.innerHTML = '<svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>';
                    okBtn.className = 'flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest bg-green-500 text-white hover:bg-green-600 transition-all';
                    okBtn.textContent = 'Confirm | \u062a\u0623\u0643\u064a\u062f';
                }

                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-100', 'pointer-events-auto');
                setTimeout(() => content.classList.remove('scale-95'), 10);
            });
        }

        window.resolveCheckoutConfirm = function(val) {
            const modal = document.getElementById('checkoutConfirmModal');
            const content = document.getElementById('checkoutConfirmContent');
            content.classList.add('scale-95');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.classList.remove('opacity-100', 'pointer-events-auto');
            if (checkoutConfirmResolver) {
                checkoutConfirmResolver(val);
                checkoutConfirmResolver = null;
            }
        };
    </script>
</body>
</html>
