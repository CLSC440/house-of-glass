<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Of Glass | Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brandBlue: '#0A3654',
                        brandGold: '#C19B4E',
                        darkBg: '#0F172A',
                        darkCard: '#1E293B'
                    },
                    fontFamily: {
                        arabic: ['Almarai', 'Cairo', 'sans-serif'],
                    }
                }
            }
        }

        // --- Smart Theme Logic ---
        function applySmartTheme() {
            const isAutoEnabled = localStorage.getItem('autoThemeEnabled') !== 'false'; // Default to true
            const manualTheme = localStorage.getItem('darkMode');
            const overrideTime = localStorage.getItem('themeOverrideTime');
            const now = Date.now();
            
            if (!isAutoEnabled) {
                // If auto is disabled, strictly follow manual choice or system preference
                if (manualTheme === 'true') document.documentElement.classList.add('dark');
                else if (manualTheme === 'false') document.documentElement.classList.remove('dark');
                return;
            }

            // Return to Auto mode after 10 minutes (600,000ms)
            if (overrideTime && (now - overrideTime > 600000)) {
                localStorage.removeItem('darkMode');
                localStorage.removeItem('themeOverrideTime');
            } else if (manualTheme !== null) {
                if (manualTheme === 'true') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                return;
            }

            const hour = new Date().getHours();
            if (hour < 6 || hour >= 18) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applySmartTheme();
    </script>
    <style>
        * {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #C19B4E rgba(193, 155, 78, 0.05);
        }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Professional Scrollbar Styling - Global */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(193, 155, 78, 0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #C19B4E, #a67c3a);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #d4ad5a, #C19B4E);
        }
        .dark ::-webkit-scrollbar-track {
            background: rgba(193, 155, 78, 0.08);
        }
        
        /* Animations */
        .reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s ease-out;
        }
        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        #swipeArea {
            touch-action: pan-y;
            user-select: none;
        }
        
        #mainDetailImg {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #C19B4E33;
            border-radius: 10px;
        }
        /* Dark toggle: fully circular by default, expands to pill on hover or click */
        #darkToggle {
            width: 3rem; /* default resting width */
            height: 3rem;
            padding: 0 0.35rem;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #darkToggle.expanded, #darkToggle:hover {
            width: 9rem !important; /* ~144px */
        }
        #darkTextDay, #darkTextNight {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            white-space: nowrap;
        }
        /* Reveal active label when expanded */
        #darkToggle.expanded #darkTextDay, 
        #darkToggle:hover #darkTextDay {
            opacity: 1;
            visibility: visible;
        }
        .dark #darkToggle.expanded #darkTextNight,
        .dark #darkToggle:hover #darkTextNight {
            opacity: 1;
            visibility: visible;
        }
        /* Knob logic */
        #darkToggle .knob {
            width: 2.25rem;
            height: 2.25rem;
            left: 0.375rem;
            top: 0.375rem;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dark #darkToggle.expanded .knob,
        .dark #darkToggle:hover .knob {
            transform: translateX(6.5rem);
        }

        /* Mobile: keep toggle compact, hide labels */
        @media (max-width: 768px) {
            #darkToggle,
            #darkToggle.expanded,
            #darkToggle:hover {
                width: 3.1rem !important;
                height: 3.1rem;
                padding: 0 0.35rem;
            }
            #darkTextDay,
            #darkTextNight {
                display: none !important;
            }
            #darkToggle .knob {
                left: 0.45rem;
                top: 0.45rem;
            }
            .dark #darkToggle.expanded .knob,
            .dark #darkToggle:hover .knob {
                transform: translateX(0);
            }

            #headerUserProfile {
                min-width: auto !important;
                max-width: 220px;
                padding: 0.45rem 0.9rem;
                gap: 0.5rem;
            }
            #headerUserProfile .profile-text {
                max-width: 120px;
            }
        }

        /* Ultra-Realistic Warm Glass & Sunlight Effect */
        @keyframes rim-glow {
            0%, 100% { 
                filter: 
                    drop-shadow(0 0 1px rgba(255, 236, 180, 0.8)) 
                    drop-shadow(0 0 8px rgba(193, 155, 78, 0.3))
                    brightness(1.15) contrast(1.1); 
            }
            50% { 
                filter: 
                    drop-shadow(0 0 2px rgba(255, 245, 220, 1)) 
                    drop-shadow(0 0 12px rgba(212, 175, 55, 0.5))
                    brightness(1.3) contrast(1.15); 
            }
        }
        @keyframes sparkle {
            0%, 100% { opacity: 0.4; transform: scale(0.8) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.1) rotate(15deg); }
        }
        .shine-effect {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        .dark .shine-effect img {
            animation: rim-glow 6s ease-in-out infinite;
            transition: all 0.5s ease;
            image-rendering: -webkit-optimize-contrast;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-darkBg font-sans transition-colors duration-300">

    <!-- Header -->
    <header class="bg-white/80 dark:bg-[#20293D]/90 backdrop-blur-md sticky top-0 z-50 border-b border-brandGold/20 transition-all duration-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 md:h-24 flex items-center justify-between">
            <!-- Left: Toggle Sidebar (Mobile flex-1 to push logo to center) -->
            <div class="flex-1 md:flex-none">
                <button onclick="toggleSidebar()" class="p-2 text-brandBlue dark:text-brandGold hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>

            <!-- Middle: Logo (Centered on mobile via flex-none and justify-center container) -->
            <div class="flex-none md:flex-1 flex justify-center md:justify-start md:ml-4">
                <a href="index.html" class="flex items-center group">
                    <div class="shine-effect">
                        <img src="logo.png" alt="Logo" class="h-24 md:h-32 w-auto transition-all group-hover:scale-105 relative z-10">
                    </div>
                    <span class="ml-3 text-xl md:text-2xl font-bold text-brandBlue dark:text-brandGold hidden lg:block tracking-[-0.03em] font-sans">House Of Glass</span>
                </a>
            </div>
            
            <!-- Right: Controls -->
            <div class="flex-1 md:flex-none flex items-center justify-end space-x-3 md:space-x-6">
                <!-- User Profile Card (Top Bar) -->
                <div id="headerUserProfile" class="hidden items-center justify-between space-x-3 md:space-x-4 px-4 py-2 md:px-5 md:py-2.5 bg-gray-50 dark:bg-gray-800 rounded-full border border-gray-100 dark:border-gray-700 shadow-[0_12px_30px_rgba(10,54,84,0.15)] min-w-[190px] md:min-w-[220px] w-auto">
                    <!-- Will be populated by JS -->
                </div>
                
                <!-- Dark Mode Toggle Switch -->
                <button onclick="toggleDarkMode()" class="relative w-10 h-10 rounded-full bg-gray-200 dark:bg-[#061e31] transition-all duration-500 flex items-center shadow-inner overflow-hidden ring-1 ring-black/5 dark:ring-white/20 group cursor-pointer" id="darkToggle">
                    <!-- Text: DAY MODE (Visible in Light Mode) -->
                    <span id="darkTextDay" class="absolute right-4 text-[9px] font-black tracking-[0.2em] text-gray-800 dark:hidden" data-i18n="day_mode">DAY MODE</span>
                    <!-- Text: NIGHT MODE (Visible in Dark Mode) -->
                    <span id="darkTextNight" class="absolute left-4 text-[9px] font-black tracking-[0.2em] text-white hidden dark:block" data-i18n="night_mode">NIGHT MODE</span>
                    
                    <!-- Sliding Circle with Icons -->
                    <div class="knob absolute left-1 top-1 bg-white dark:bg-darkCard w-8 h-8 rounded-full shadow-md grid place-items-center dark:shadow-[0_0_10px_rgba(255,255,255,0.1)] transition-colors duration-500">
                        <!-- Sun Icon (Visible in Light Mode) -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-brandGold transition-opacity duration-300 col-start-1 row-start-1 opacity-100 dark:opacity-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <circle cx="12" cy="12" r="4" stroke-width="2"></circle>
                            <path stroke-linecap="round" stroke-width="2" d="M12 2v2m0 16v2m8-10h2M2 12h2m14.14-7.07l-1.41 1.41M4.93 19.07l1.41-1.41M19.07 19.07l-1.41-1.41M4.93 4.93l1.41 1.41" />
                        </svg>
                        <!-- Moon Icon (Visible in Dark Mode) -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-brandGold transition-opacity duration-300 col-start-1 row-start-1 opacity-0 dark:opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 6l1 2 2 1-2 1-1 2-1-2-2-1 2-1 1-2z M5 8l1 1 1 .5-1 .5-1 1-.5-1-1-.5 1-.5 .5-1z" class="opacity-0 dark:opacity-100" />
                        </svg>
                    </div>
                </button>

                <nav id="headerNav" class="hidden md:flex items-center space-x-6">
                    <a href="index.html" class="text-brandBlue dark:text-white border-b-2 border-brandGold px-1 py-1 text-sm font-bold" data-i18n="home">Home</a>
                    <!-- Dynamic button injected by JS -->
                </nav>
            </div>
        </div>
    </header>

    <!-- Sidebar / Drawer -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-[60] opacity-0 pointer-events-none transition-opacity duration-300" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="fixed top-0 left-0 w-72 h-full bg-white dark:bg-darkCard z-[70] -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
        <div id="sidebarHeader" class="p-5 border-b dark:border-gray-700 flex justify-between items-center">
            <h2 class="text-xl font-bold text-brandBlue dark:text-brandGold italic" data-i18n="categories">Categories</h2>
            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-brandBlue dark:hover:text-white text-xl font-bold">✕</button>
        </div>
        <div id="categoryList" class="flex-grow overflow-y-auto py-4">
            <!-- Categories will be injected here -->
        </div>
        <div class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
            <a href="login.html" class="block text-center bg-brandBlue text-white py-3 rounded-xl font-bold border border-brandGold hover:bg-opacity-90" data-i18n="admin_dashboard">Admin Dashboard</a>
        </div>
    </div>

    <!-- Hero -->
    <section class="bg-gray-50 dark:bg-brandBlue py-16 md:py-32 text-center relative overflow-hidden transition-all duration-1000">
        <!-- Subtle backround effect -->
        <div class="absolute inset-0 opacity-40 dark:opacity-20 pointer-events-none">
            <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_50%_50%,_rgba(193,155,78,0.2),transparent_70%)] dark:bg-[radial-gradient(circle_at_50%_50%,_rgba(193,155,78,0.15),transparent_70%)]"></div>
        </div>
        
        <div class="relative z-10 px-4 reveal active">
            <h2 class="text-3xl md:text-7xl font-black mb-4 text-brandGold tracking-tighter uppercase drop-shadow-sm dark:drop-shadow-[0_0_20px_rgba(193,155,78,0.4)]">House Of Glass</h2>
            
            <div class="flex flex-col items-center justify-center mb-12 md:mb-16">
                <p class="text-[8px] md:text-xs tracking-[0.4em] md:tracking-[0.6em] uppercase text-brandBlue/40 dark:text-white/40 font-bold mb-6 md:mb-10 transition-all hover:opacity-60 cursor-default" data-i18n="showroom">Showroom for Home Glassware</p>
                
                <div class="flex items-center justify-center w-full max-w-3xl mx-auto group">
                    <div class="flex-grow h-[1px] bg-gradient-to-l from-brandGold via-brandGold/40 to-transparent transition-all duration-1000 group-hover:from-brandBlue dark:group-hover:from-white"></div>
                    <p class="text-3xl md:text-7xl font-black text-brandBlue dark:text-white font-arabic px-6 md:px-16 whitespace-nowrap leading-none transition-all duration-700 hover:scale-105" dir="rtl" style="text-shadow: 0 10px 30px rgba(10,54,84,0.1); dark:text-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                        ال عاشور عدس
                    </p>
                    <div class="flex-grow h-[1px] bg-gradient-to-r from-brandGold via-brandGold/40 to-transparent transition-all duration-1000 group-hover:from-brandBlue dark:group-hover:from-white"></div>
                </div>
            </div>
            
            <p class="text-sm md:text-2xl text-brandBlue/60 dark:text-white/60 max-w-2xl mx-auto font-light tracking-widest italic font-serif mt-4 md:mt-8" data-i18n="excellence">"Excellence in every reflection."</p>
        </div>
    </section>

    <!-- Search Section -->
    <div class="max-w-7xl mx-auto px-4 -mt-8 md:-mt-10 relative z-20">
        <div class="bg-white dark:bg-darkCard rounded-2xl shadow-xl p-4 md:p-6 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-6 border border-brandGold/20">
            <div class="flex-grow relative">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="searchInput" placeholder="Search by name or category..." data-i18n-placeholder="search_placeholder" class="w-full pl-11 md:pl-12 pr-4 py-3 md:py-4 rounded-xl bg-gray-50 dark:bg-gray-800 dark:text-white border-none focus:ring-2 focus:ring-brandGold outline-none transition-all text-sm md:text-base">
            </div>
            
            <!-- Category Dropdown -->
            <div class="relative group/cat">
                <button onclick="toggleCatDropdown()" class="w-full h-full min-w-[160px] flex items-center justify-between px-5 md:px-6 bg-brandGold/10 text-brandGold rounded-xl font-bold py-3 md:py-4 hover:bg-brandGold/20 transition-all text-sm md:text-base">
                    <span id="activeFilterDisplay" data-i18n="category_all">Category: All</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2 transition-transform group-hover/cat:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div id="catDropdown" class="absolute right-0 top-full mt-2 w-full min-w-[200px] bg-white dark:bg-darkCard rounded-xl shadow-2xl border border-gray-100 dark:border-gray-700 py-2 hidden z-[60]">
                    <!-- Dropdown items will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Grid -->
    <main class="max-w-7xl mx-auto px-4 md:px-6 py-16 md:py-24 min-h-[60vh]">
        <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-10"></div>
    </main>

    <!-- Floating Contact (WhatsApp) -->
    <a id="floatingWhatsapp" href="https://wa.me/201026600350" target="_blank" class="fixed bottom-6 right-6 z-[80] bg-[#25D366] text-white p-3 rounded-full shadow-2xl hover:scale-110 transition-all flex items-center group translate-y-20 opacity-0 invisible">
        <svg viewBox="0 0 24 24" class="h-6 w-6" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
        <span class="max-w-0 overflow-hidden group-hover:max-w-xs group-hover:ml-2 transition-all duration-300 font-bold whitespace-nowrap text-sm">Contact Us</span>
    </a>

    <footer class="bg-white dark:bg-darkCard border-t border-gray-100 dark:border-gray-800 pt-24 pb-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <div class="mb-16 flex flex-col items-center">
                <div class="shine-effect">
                    <img src="logo.png" alt="Logo" class="h-32 md:h-48 transition-all cursor-pointer relative z-10" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                </div>
                
                <p class="text-[10px] md:text-xs font-black tracking-[0.4em] uppercase opacity-40 dark:text-brandGold dark:opacity-80 mb-8" data-i18n="powered_by">Powered By</p>

                <div class="flex items-center justify-center space-x-6 md:space-x-8 mb-6">
                    <div class="h-px w-6 md:w-8 bg-gradient-to-l from-brandGold/40 to-transparent"></div>
                    <p class="text-2xl md:text-3xl font-black text-brandBlue dark:text-brandGold font-arabic tracking-tight" dir="rtl">ال عاشور عدس</p>
                    <div class="h-px w-6 md:w-8 bg-gradient-to-r from-brandGold/40 to-transparent"></div>
                </div>
                
                <p class="text-brandBlue dark:text-brandGold/80 text-[10px] md:text-xs font-black tracking-[0.3em] uppercase opacity-70 mb-10" data-i18n="premium_home_glassware">Al Ashour Ades Showroom</p>

                <!-- Social Links -->
                <div class="flex items-center justify-center space-x-8 mb-12">
                    <button onclick="openContactPicker()" class="text-gray-400 hover:text-brandGold transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                    </button>
                    <a id="footerWhatsapp" href="https://wa.me/201026600350" target="_blank" class="text-gray-400 hover:text-[#25D366] transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                    </a>
                    <a id="footerFacebook" href="#" target="_blank" class="text-gray-400 hover:text-brandGold transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                    </a>
                    <a id="footerMaps" href="#" target="_blank" class="text-gray-400 hover:text-brandGold transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>
                    </a>
                </div>
            </div>
            
            <div class="border-t border-gray-100 dark:border-gray-800 pt-8 flex flex-col md:flex-row justify-between items-center text-gray-400 text-[10px] md:text-xs">
                <p class="mb-4 md:mb-0">© 2026 Al Ashour Ades. All rights reserved.</p>
                <div class="flex space-x-6">
                    <span>Sat - Thu: 10AM - 10PM</span>
                    <span class="text-brandGold font-bold tracking-widest uppercase" data-i18n="premium_home_glassware">Premium Home Glassware</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- PRODUCT DETAIL MODAL -->
    <div id="detailModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-80" onclick="closeDetails()"></div>
        <div class="modal-container bg-white dark:bg-darkCard w-[92%] md:max-w-4xl mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden flex flex-col md:flex-row max-h-[90vh] md:max-h-[80vh] transition-all duration-300 transform">
            <!-- Image Section -->
            <div class="w-full md:w-1/2 bg-gray-100 dark:bg-gray-800 flex flex-col overflow-hidden relative group">
                <!-- Close button for mobile/desktop over image -->
                <button onclick="closeDetails()" class="absolute top-3 right-3 z-[60] bg-white/80 dark:bg-black/50 backdrop-blur-md text-gray-800 dark:text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg hover:bg-white dark:hover:bg-black transition-all active:scale-95">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

                <div id="swipeArea" class="flex-grow flex items-center justify-center p-3 md:p-6 touch-pan-y h-[32vh] md:h-auto">
                    <img id="mainDetailImg" src="" class="max-w-full max-h-full object-contain rounded-xl select-none transition-transform duration-300">
                </div>
                <div id="thumbnailBar" class="h-16 md:h-24 bg-white/50 dark:bg-darkCard/50 backdrop-blur-sm border-t dark:border-gray-700 flex space-x-3 p-3 overflow-x-auto hide-scroll justify-center">
                    <!-- Thumbnails will go here -->
                </div>
            </div>

            <!-- Content Section -->
            <div class="w-full md:w-1/2 p-5 md:p-8 flex flex-col justify-between overflow-y-auto">
                <div class="space-y-4 md:space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 id="detailTitle" class="text-lg md:text-2xl font-black text-brandBlue dark:text-white uppercase italic tracking-tighter"></h2>
                        <!-- Desktop close button removed from here, integrated into image section -->
                    </div>
                    <div class="w-12 h-1 bg-brandGold rounded-full"></div>
                    <p id="detailDesc" class="text-xs md:text-sm text-gray-600 dark:text-gray-300 leading-relaxed font-medium"></p>
                </div>
                <div class="mt-6 md:mt-10">
                    <a id="enquiryBtn" href="#" target="_blank" class="flex items-center justify-center space-x-2 w-full bg-[#25D366] text-white py-2.5 md:py-4 rounded-xl font-bold hover:bg-opacity-90 transition-all shadow-lg text-xs md:text-base">
                        <svg viewBox="0 0 24 24" class="h-5 w-5 md:h-6 md:w-6" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                        <span>Ask on WhatsApp</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- User Settings Modal -->
    <div id="userSettingsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100] transition-all duration-300">
        <div class="absolute w-full h-full bg-black/60 backdrop-blur-sm" onclick="closeUserSettingsModal()"></div>
        <div class="bg-white dark:bg-darkCard w-11/12 max-w-md mx-auto rounded-3xl shadow-2xl z-[110] overflow-hidden relative border border-gray-100 dark:border-gray-800">
            <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50">
                <h2 class="text-xl font-black text-brandBlue dark:text-brandGold uppercase italic tracking-tight" data-i18n="account_settings">Account Settings</h2>
                <button onclick="closeUserSettingsModal()" class="text-gray-400 hover:text-red-500 transition-colors bg-white dark:bg-gray-700 p-2 rounded-full shadow-sm">✕</button>
            </div>
            
            <form id="userSettingsForm" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto custom-scroll">
                <!-- Profile Image Section -->
                <div class="flex flex-col items-center mb-6">
                    <div class="relative group">
                        <div id="settingsPhotoPreview" class="w-24 h-24 rounded-full bg-brandGold/10 border-4 border-white dark:border-gray-800 shadow-xl overflow-hidden flex items-center justify-center text-4xl text-brandGold font-black uppercase">
                            ?
                        </div>
                        <label class="absolute bottom-0 right-0 bg-brandBlue text-white p-2 rounded-full shadow-lg cursor-pointer hover:scale-110 transition-transform border-2 border-white dark:border-gray-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <input type="file" id="userPhotoInput" class="hidden" accept="image/*" onchange="handleUserPhoto(this)">
                        </label>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 uppercase tracking-widest font-bold" data-i18n="change_profile_photo">Change Profile Photo</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1" data-i18n="full_name">Full Name</label>
                        <input type="text" id="settingsName" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none dark:text-white">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1" data-i18n="email_address">Email Address</label>
                        <input type="email" id="settingsEmail" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm text-gray-500 dark:text-gray-400 outline-none" readonly>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1" data-i18n="phone_number">Phone Number</label>
                        <input type="tel" id="settingsPhone" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none dark:text-white" placeholder="01XXXXXXXXX">
                    </div>
                    
                    <div class="pt-4 border-t dark:border-gray-700">
                        <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-1" data-i18n="change_password">Change Password</label>
                        <div class="relative">
                            <input type="password" id="settingsNewPassword" placeholder="New Password" data-i18n-placeholder="new_password" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm focus:ring-2 focus:ring-brandGold outline-none dark:text-white mb-2">
                        </div>
                        <p class="text-[10px] text-gray-400 italic" data-i18n="leave_empty_keep">* Leave empty to keep current password</p>
                    </div>

                    <!-- Appearance Settings -->
                    <div class="pt-4 border-t dark:border-gray-700">
                        <label class="block text-xs font-black text-brandBlue dark:text-brandGold uppercase tracking-widest mb-3">Appearance</label>
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-100 dark:border-gray-700">
                            <div>
                                <p class="text-sm font-bold text-gray-700 dark:text-gray-200" data-i18n="auto_theme">Auto Day/Night Mode</p>
                                <p class="text-[10px] text-gray-400 italic" data-i18n="auto_theme_desc">Switch based on sun time (10 min reset)</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="settingsAutoTheme" class="sr-only peer" onchange="toggleAutoTheme(this.checked)">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none ring-4 ring-brandGold/10 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-brandGold"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="settingsMessage" class="hidden text-center text-xs p-2 rounded-lg"></div>

                <div class="flex space-x-3 pt-6">
                    <button type="button" onclick="closeUserSettingsModal()" class="flex-1 px-4 py-3 text-gray-500 font-bold text-sm bg-gray-50 dark:bg-gray-800 rounded-xl hover:bg-gray-100 transition-all" data-i18n="cancel">Cancel</button>
                    <button type="submit" id="saveSettingsBtn" class="flex-2 px-8 py-3 bg-brandBlue text-white rounded-xl font-black text-sm border border-brandGold/30 shadow-lg shadow-brandBlue/20 hover:scale-105 transition-all" data-i18n="save_changes">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contact Picker Modal -->
    <div id="contactPickerModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[120] transition-all duration-300">
        <div class="absolute w-full h-full bg-black/60 backdrop-blur-sm" onclick="closeContactPicker()"></div>
        <div class="bg-white dark:bg-darkCard w-11/12 max-w-xs mx-auto rounded-3xl shadow-2xl z-[130] overflow-hidden relative border border-brandGold/20">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-brandGold/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-brandGold" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                </div>
                <h3 class="text-xl font-black text-brandBlue dark:text-brandGold uppercase italic mb-6" data-i18n="contact_picker_title">Contact Us</h3>
                <div id="contactPickerList" class="space-y-3">
                    <!-- Numbers will be injected here -->
                </div>
                <button onclick="closeContactPicker()" class="mt-8 text-gray-400 font-bold hover:text-red-500 transition-colors uppercase text-xs tracking-widest" data-i18n="cancel">Close</button>
            </div>
        </div>
    </div>

    <script src="locales-data.js"></script>
    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, onSnapshot, query, orderBy, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_oTePhmWmzuOcZDmc_-7bhoAVbYVhH3Q",
            authDomain: "houseofglass-440.firebaseapp.com",
            projectId: "houseofglass-440",
            storageBucket: "houseofglass-440.firebasestorage.app",
            messagingSenderId: "73082039144",
            appId: "1:73082039144:web:0658e54416293334dc84dd",
            measurementId: "G-S81YY4Z4RM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let products = [];
        let categories = ['All'];
        let activeCategory = 'All';
        let searchQuery = '';
        let whatsappNumber = '201026600350';
        let sitePhones = [];
        let currentUser = null;
        let userFavorites = [];

        const grid = document.getElementById('product-grid');
        const modal = document.getElementById('detailModal');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const searchInput = document.getElementById('searchInput');

        // User Settings Functions
        window.openUserSettingsModal = async () => {
            if (!currentUser) return;
            const userDoc = await getDoc(doc(db, "users", currentUser.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('settingsName').value = data.name || '';
                document.getElementById('settingsEmail').value = currentUser.email || data.email || '';
                document.getElementById('settingsPhone').value = data.phone || '';
                if (data.photoURL) {
                    document.getElementById('settingsPhotoPreview').innerHTML = `<img src="${data.photoURL}" class="w-full h-full object-cover">`;
                } else {
                    document.getElementById('settingsPhotoPreview').innerText = (data.name?.[0] || currentUser.email[0]).toUpperCase();
                }
            }
            // Load auto theme setting
            document.getElementById('settingsAutoTheme').checked = localStorage.getItem('autoThemeEnabled') !== 'false';
            
            document.getElementById('userSettingsModal').classList.remove('opacity-0', 'pointer-events-none');
        };

        window.toggleAutoTheme = (enabled) => {
            localStorage.setItem('autoThemeEnabled', enabled);
            if (enabled) {
                // If turning ON, clear manual toggle and apply immediately
                localStorage.removeItem('darkMode');
                localStorage.removeItem('themeOverrideTime');
                applySmartTheme();
            }
        };

        window.closeUserSettingsModal = () => {
            document.getElementById('userSettingsModal').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('settingsMessage').className = 'hidden';
            document.getElementById('settingsNewPassword').value = '';
        };

        window.handleUserPhoto = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('settingsPhotoPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                    document.getElementById('settingsPhotoPreview').dataset.newPhoto = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // Helper to Compress Images before saving to Firestore (Avoiding Storage Bucket dependency)
        function compressImage(base64Str, maxWidth = 1000, maxHeight = 1000) {
            return new Promise((resolve) => {
                let img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    let canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    let ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // Compress to 70% quality JPEG
                };
            });
        }

        document.getElementById('userSettingsForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveSettingsBtn');
            const msg = document.getElementById('settingsMessage');
            const name = document.getElementById('settingsName').value;
            const phone = document.getElementById('settingsPhone').value;
            const pass = document.getElementById('settingsNewPassword').value;
            const photoPreview = document.getElementById('settingsPhotoPreview');
            const photo = photoPreview.dataset.newPhoto;

            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                const updates = { name, phone };
                
                // If there's a new photo, compress and save Base64 directly to Firestore
                if (photo && photo.startsWith('data:image')) {
                    // Compress to reduce size (same approach used in admin panel)
                    msg.innerText = 'Processing photo...';
                    msg.className = 'text-center text-xs p-2 rounded-lg bg-brandGold/10 text-brandGold block mt-4';
                    const compressed = await compressImage(photo, 800, 800);
                    updates.photoURL = compressed;
                }
                
                await updateDoc(doc(db, "users", currentUser.uid), updates);

                if (pass) {
                    await updatePassword(currentUser, pass);
                }

                msg.innerText = "Profile updated successfully!";
                msg.className = "text-center text-xs p-2 rounded-lg bg-green-100 text-green-700 block bg-opacity-50 mt-4 font-bold";
                
                setTimeout(() => {
                    closeUserSettingsModal();
                    location.reload(); // Refresh to show new name/photo
                }, 1500);

            } catch (error) {
                msg.innerText = "Error: " + error.message;
                msg.className = "text-center text-xs p-2 rounded-lg bg-red-100 text-red-700 block bg-opacity-50 mt-4";
                btn.disabled = false;
                btn.innerText = "Save Changes";
            }
        };

        // Auth listener
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const sidebarFooter = document.querySelector('#sidebar .border-t');
            const headerNav = document.getElementById('headerNav');
            const homeLink = `<a href="index.html" class="text-brandBlue dark:text-white border-b-2 border-brandGold px-1 py-1 text-sm font-bold" data-i18n="home">Home</a>`;
            
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    userFavorites = userDoc.data().favorites || [];
                    const role = userDoc.data().role || 'customer';
                    
                    // Update Header
                    if (role === 'admin' || role === 'moderator') {
                        headerNav.innerHTML = `${homeLink} <a href="admin.html" class="text-brandGold hover:text-brandBlue dark:hover:text-white px-1 py-1 text-sm font-bold transition-colors" data-i18n="admin_dashboard">Admin Dashboard</a>`;
                    } else {
                        headerNav.innerHTML = homeLink;
                    }

                    // Update footer with logout and dashboard buttons
                    sidebarFooter.style.display = 'block';
                    sidebarFooter.innerHTML = `
                        <div class="flex flex-col space-y-2">
                            <button onclick="window.logout()" class="w-full bg-red-500/10 text-red-500 py-2.5 rounded-xl text-xs font-bold border border-red-500/20 hover:bg-red-500 hover:text-white transition-all" data-i18n="logout">Logout</button>
                            ${(role === 'admin' || role === 'moderator') ? `<a href="admin.html" class="block text-center bg-brandBlue text-white py-2.5 rounded-xl font-bold border border-brandGold hover:bg-opacity-90 text-xs shadow-xl shadow-brandBlue/20" data-i18n="admin_dashboard">Admin Dashboard</a>` : ''}
                        </div>
                    `;
                    
                    // Replace header with profile card
                    const sidebarHeader = document.getElementById('sidebarHeader');
                    sidebarHeader.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center space-x-3 flex-1">
                                <div onclick="window.openUserSettingsModal()" class="w-10 h-10 rounded-full bg-brandGold flex items-center justify-center text-white text-sm font-bold shadow-lg shadow-brandGold/20 overflow-hidden cursor-pointer hover:scale-105 transition-transform">
                                    ${userDoc.data().photoURL ? `<img src="${userDoc.data().photoURL}" class="w-full h-full object-cover">` : user.email[0].toUpperCase()}
                                </div>
                                <div class="overflow-hidden flex-1" onclick="window.openUserSettingsModal()" class="cursor-pointer">
                                    <p class="text-sm font-bold dark:text-white truncate">${userDoc.data().name || user.email.split('@')[0]}</p>
                                    <p class="text-[10px] text-brandGold uppercase font-black tracking-widest">${role}</p>
                                </div>
                            </div>
                            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-brandBlue dark:hover:text-white text-xl font-bold ml-2">✕</button>
                        </div>
                    `;
                    
                    // Also populate header profile card
                    const headerProfile = document.getElementById('headerUserProfile');
                    if (headerProfile) {
                        headerProfile.innerHTML = `
                            <div class="flex items-center space-x-2 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.openUserSettingsModal()">
                                <div class="w-6 h-6 rounded-full bg-brandGold flex items-center justify-center text-white text-[10px] font-bold shadow-lg shadow-brandGold/20 overflow-hidden">
                                    ${userDoc.data().photoURL ? `<img src="${userDoc.data().photoURL}" class="w-full h-full object-cover">` : user.email[0].toUpperCase()}
                                </div>
                                <div class="overflow-hidden profile-text">
                                    <p class="text-[9px] font-bold dark:text-white truncate">${userDoc.data().name || user.email.split('@')[0]}</p>
                                    <p class="text-[7px] text-brandGold uppercase font-black">${role}</p>
                                </div>
                            </div>
                            <button onclick="window.openUserSettingsModal()" class="hidden md:inline-block p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Settings">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brandGold" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                            <button onclick="window.logout()" class="hidden md:inline-block p-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="Logout">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                </svg>
                            </button>
                        `;
                        headerProfile.classList.remove('hidden', 'md:hidden');
                        headerProfile.classList.add('flex', 'md:flex');
                    }
                }
            } else {
                userFavorites = [];
                headerNav.innerHTML = `${homeLink} <a href="login.html" class="text-brandGold hover:text-brandBlue dark:hover:text-white px-1 py-1 text-sm font-bold transition-colors" data-i18n="login_signup">Login / Sign Up</a>`;
                
                // Show header login capsule on mobile with same styling as profile capsule
                const headerProfile = document.getElementById('headerUserProfile');
                if (headerProfile) {
                    headerProfile.innerHTML = `
                        <button onclick="window.location.href='login.html'" class="w-full flex items-center justify-between gap-4 text-left group">
                            <div class="flex items-center space-x-3">
                                <div class="w-6 h-6 rounded-full bg-brandGold flex items-center justify-center text-white text-[10px] font-black shadow-lg shadow-brandGold/20">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.121 17.804A8 8 0 1118.364 4.56 8 8 0 015.12 17.804z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM6.75 18A5.25 5.25 0 0112 15.75 5.25 5.25 0 0117.25 18" />
                                    </svg>
                                </div>
                                <div class="text-left profile-text">
                                    <p class="text-[9px] font-bold text-brandBlue dark:text-white tracking-tight uppercase">Guest</p>
                                    <p class="text-[7px] text-brandGold uppercase font-black tracking-[0.4em]" data-i18n="login_signup">Login / Sign Up</p>
                                </div>
                            </div>
                            <span class="p-1.5 rounded-full bg-brandGold/10 text-brandGold transition-transform duration-300 group-hover:translate-x-1 group-hover:bg-brandGold/20">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </span>
                        </button>
                    `;
                    headerProfile.classList.remove('hidden', 'md:flex');
                    headerProfile.classList.add('flex', 'md:hidden');
                }
                
                // Hide footer for non-logged in users
                sidebarFooter.style.display = 'none';
                
                // Replace header with Login/Signup button for non-logged in users
                const sidebarHeader = document.getElementById('sidebarHeader');
                sidebarHeader.innerHTML = `
                    <a href="login.html" class="flex-1 text-center bg-brandBlue text-white py-3 rounded-xl font-black border border-brandGold hover:bg-opacity-90 transition-all shadow-xl shadow-brandBlue/20 uppercase tracking-widest text-[10px]" data-i18n="login_signup">Login / Sign Up</a>
                    <button onclick="toggleSidebar()" class="text-gray-400 hover:text-brandBlue dark:hover:text-white text-xl font-bold ml-3">✕</button>
                `;
            }
            // Add "My Favorites" to categories if not present
            if (user && !categories.includes('My Favorites')) {
                categories.splice(1, 0, 'My Favorites');
            } else if (!user && categories.includes('My Favorites')) {
                categories = categories.filter(c => c !== 'My Favorites');
                if (activeCategory === 'My Favorites') activeCategory = 'All';
            }
            if (window.applyI18n) {
                window.applyI18n();
            }
            renderCategories();
            renderProducts();
        });

        window.logout = () => signOut(auth);

        window.openContactPicker = () => {
            const list = document.getElementById('contactPickerList');
            list.innerHTML = sitePhones.map(p => `
                <a href="tel:${p}" class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl hover:bg-brandGold/10 transition-all group border border-transparent hover:border-brandGold/30">
                    <span class="text-sm font-bold text-brandBlue dark:text-white">${p}</span>
                    <svg class="w-5 h-5 text-brandGold group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                </a>
            `).join('');
            document.getElementById('contactPickerModal').classList.remove('opacity-0', 'pointer-events-none');
        };

        window.closeContactPicker = () => {
            document.getElementById('contactPickerModal').classList.add('opacity-0', 'pointer-events-none');
        };


        async function loadData() {
            try {
                // Load Settings (Contacts)
                onSnapshot(doc(db, "settings", "contact"), (docSnap) => {
                    if (docSnap.exists()) {
                        whatsappNumber = docSnap.data().whatsapp || '201026600350';
                        const fb = docSnap.data().facebook || '#';
                        const maps = docSnap.data().maps || '#';
                        const waChannel = docSnap.data().whatsappChannel || '#';

                        document.getElementById('floatingWhatsapp').href = `https://wa.me/${whatsappNumber}`;
                        document.getElementById('footerWhatsapp').href = waChannel;
                        
                        // Handle Multiple Phone Numbers
                        sitePhones = (docSnap.data().phone || '+201026600350').split(',').map(p => p.trim()).filter(p => p);

                        document.getElementById('footerFacebook').href = fb;
                        document.getElementById('footerMaps').href = maps;
                    }
                });

                // Load Categories (Fetch all then sort in JS for safety)
                const catSnapshot = await getDocs(collection(db, "categories"));
                const fetchedCatsData = catSnapshot.docs.map((doc, idx) => {
                    const data = doc.data();
                    return { name: data.name, order: data.order !== undefined ? data.order : idx };
                }).sort((a, b) => a.order - b.order);
                
                const fetchedCats = fetchedCatsData.map(c => c.name);
                categories = ['All', ...fetchedCats];
                if (currentUser) categories.splice(1, 0, 'My Favorites');
                
                // Load Products
                const prodSnapshot = await getDocs(query(collection(db, "products"), orderBy("createdAt", "desc")));
                products = prodSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderCategories();
                renderProducts();
            } catch (error) {
                console.error("Error loading data:", error);
            }
        }

        window.toggleSidebar = function() {
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            if (isOpen) {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
                document.body.style.overflow = '';
            } else {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('opacity-0', 'pointer-events-none');
                document.body.style.overflow = 'hidden';
            }
        }

        window.toggleCatDropdown = function() {
            const dropdown = document.getElementById('catDropdown');
            dropdown.classList.toggle('hidden');
        }

        window.addEventListener('click', (e) => {
            const dropdown = document.getElementById('catDropdown');
            if (dropdown && !dropdown.classList.contains('hidden') && !e.target.closest('.group\\/cat')) {
                dropdown.classList.add('hidden');
            }
        });

        function renderCategories() {
            const catList = document.getElementById('categoryList');
            const catDropdown = document.getElementById('catDropdown');
            catList.innerHTML = '';
            catDropdown.innerHTML = '';

            categories.forEach(cat => {
                // Sidebar
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-6 py-3.5 text-sm font-bold transition-all flex items-center space-x-3 ${activeCategory === cat ? 'text-brandGold border-r-4 border-brandGold bg-brandGold/5' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800'}`;
                btn.innerHTML = `
                    ${cat === 'My Favorites' ? '<svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>' : ''}
                    <span>${cat}</span>
                `;
                btn.onclick = () => { selectCategory(cat); window.toggleSidebar(); };
                catList.appendChild(btn);

                // Dropdown
                const dropBtn = document.createElement('button');
                dropBtn.className = `w-full text-left px-4 py-3 text-sm font-bold transition-colors hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center ${activeCategory === cat ? 'text-brandGold bg-brandGold/5' : 'text-gray-600 dark:text-gray-400'}`;
                dropBtn.innerText = cat;
                dropBtn.onclick = () => { selectCategory(cat); document.getElementById('catDropdown').classList.add('hidden'); };
                catDropdown.appendChild(dropBtn);
            });
        }

        function selectCategory(cat) {
            activeCategory = cat;
            document.getElementById('activeFilterDisplay').innerText = `Category: ${cat}`;
            renderProducts();
            renderCategories();
        }

        window.toggleFavorite = async (e, productId) => {
            e.stopPropagation();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            const userRef = doc(db, "users", currentUser.uid);
            const isFav = userFavorites.includes(productId);

            try {
                if (isFav) {
                    await updateDoc(userRef, { favorites: arrayRemove(productId) });
                    userFavorites = userFavorites.filter(id => id !== productId);
                } else {
                    await updateDoc(userRef, { favorites: arrayUnion(productId) });
                    userFavorites.push(productId);
                }
                renderProducts();
                // Update modal heart if open
                const modalHeart = document.querySelector('#detailModal button svg');
                if(modalHeart) modalHeart.parentElement.classList.toggle('text-red-500', !isFav);
                if(modalHeart) modalHeart.parentElement.classList.toggle('text-gray-400', isFav);
            } catch (err) {
                console.error("Error toggling favorite:", err);
            }
        };

        function renderProducts() {
            grid.innerHTML = '';
            let filtered = products;

            if (activeCategory === 'My Favorites') {
                filtered = products.filter(p => userFavorites.includes(p.id));
            } else if (activeCategory !== 'All') {
                filtered = filtered.filter(p => p.category === activeCategory);
            }

            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(q) || 
                    (p.category && p.category.toLowerCase().includes(q))
                );
            }

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400 font-arabic italic text-lg">لا يوجد ما يطابق بحثك حالياً</div>`;
                return;
            }

            filtered.forEach((p, idx) => {
                const isFav = userFavorites.includes(p.id);
                const card = document.createElement('div');
                card.className = 'reveal cursor-pointer group bg-white dark:bg-darkCard rounded-xl md:rounded-2xl shadow-sm hover:shadow-xl overflow-hidden transition-all duration-500 border border-gray-100 dark:border-gray-800';
                card.style.transitionDelay = `${idx * 50}ms`;
                card.onclick = () => showDetails(p.id);
                card.innerHTML = `
                    <div class="overflow-hidden h-44 md:h-72 relative bg-gray-50 dark:bg-gray-900/50 flex items-center justify-center">
                        <img src="${p.images[0] || 'https://via.placeholder.com/800x600?text=No+Image'}" class="w-full h-full object-contain p-2 group-hover:scale-110 transition-transform duration-700">
                        
                        <button onclick="toggleFavorite(event, '${p.id}')" class="absolute top-3 right-3 z-30 p-2 rounded-full bg-white/90 dark:bg-black/40 backdrop-blur-md shadow-lg hover:scale-110 active:scale-95 transition-all ${isFav ? 'text-red-500' : 'text-gray-400'}">
                            <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>

                        <div class="absolute top-3 left-3 bg-brandGold/90 text-white text-[8px] md:text-[10px] px-3 py-1 rounded-full font-black uppercase tracking-widest shadow-lg shadow-brandGold/20">${p.category}</div>
                        <div class="absolute bottom-3 right-3 bg-black/60 text-white text-[8px] md:text-[10px] px-3 py-1 rounded-full backdrop-blur-md font-bold">${p.images.length} Photos</div>
                    </div>
                    <div class="p-4 md:p-6">
                        <h3 class="text-sm md:text-xl font-black text-brandBlue dark:text-white truncate mb-1">${p.name}</h3>
                        <p class="text-gray-400 dark:text-gray-500 text-[10px] md:text-xs font-medium italic">View Masterpiece Details →</p>
                    </div>
                `;
                grid.appendChild(card);
            });

            setTimeout(initReveal, 100);
        }

        searchInput.oninput = (e) => {
            searchQuery = e.target.value;
            renderProducts();
        };

        function initReveal() {
            const floatingWa = document.getElementById('floatingWhatsapp');
            const reveals = document.querySelectorAll('.reveal');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) entry.target.classList.add('active');
                });
            }, { threshold: 0.1 });

            reveals.forEach(r => observer.observe(r));

            window.addEventListener('scroll', () => {
                const s = window.scrollY;
                if (s > 300) {
                    floatingWa.classList.remove('translate-y-20', 'opacity-0', 'invisible');
                    floatingWa.classList.add('translate-y-0', 'opacity-100', 'visible');
                } else {
                    floatingWa.classList.add('translate-y-20', 'opacity-0', 'invisible');
                    floatingWa.classList.remove('translate-y-0', 'opacity-100', 'visible');
                }
            });
        }

        let currentProduct = null;
        let currentImgIdx = 0;
        let touchStartX = 0;
        let touchEndX = 0;

        window.showDetails = function(id) {
            currentProduct = products.find(prod => prod.id === id);
            if (!currentProduct) return;
            currentImgIdx = 0;

            document.getElementById('detailTitle').innerText = currentProduct.name;
            document.getElementById('detailDesc').innerText = currentProduct.desc;
            updateDetailImage(0);
            updateModalFavBtn();
            
            const enquiryBtn = document.getElementById('enquiryBtn');
            const message = `مرحباً ال عاشور عدس، أود الاستفسار عن منتج: ${currentProduct.name}\n\nالوصف:\n${currentProduct.desc}`;
            enquiryBtn.href = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;

            renderThumbnails();

            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function updateModalFavBtn() {
            if (!currentProduct) return;
            const isFav = userFavorites.includes(currentProduct.id);
            const enquiryBtn = document.getElementById('enquiryBtn');
            const btnContainer = enquiryBtn.parentElement;
            
            // Remove existing fav button if any
            const oldFav = btnContainer.querySelector('.modal-fav-btn');
            if(oldFav) oldFav.remove();

            const favBtn = document.createElement('button');
            favBtn.className = `modal-fav-btn p-3 md:p-4 rounded-xl bg-gray-50 dark:bg-gray-800 transition-all border border-gray-100 dark:border-gray-700 hover:scale-105 active:scale-95 ${isFav ? 'text-red-500 shadow-lg shadow-red-500/10' : 'text-gray-400'}`;
            favBtn.innerHTML = `<svg class="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
            favBtn.onclick = async (e) => {
                await toggleFavorite(e, currentProduct.id);
                updateModalFavBtn();
            };
            
            btnContainer.className = "flex space-x-4 mt-6 md:mt-10";
            btnContainer.insertBefore(favBtn, enquiryBtn);
        }

        let isZoomed = false;

        function updateDetailImage(idx) {
            if (!currentProduct || !currentProduct.images[idx]) return;
            currentImgIdx = idx;
            const img = document.getElementById('mainDetailImg');
            
            // Reset zoom
            isZoomed = false;
            img.style.transform = 'scale(1)';
            img.style.cursor = 'zoom-in';
            
            img.style.opacity = '0';
            setTimeout(() => {
                img.src = currentProduct.images[idx];
                img.style.opacity = '1';
                renderThumbnails(); // Refresh to update active border
            }, 150);
        }

        function renderThumbnails() {
            const thumbBar = document.getElementById('thumbnailBar');
            thumbBar.innerHTML = '';
            currentProduct.images.forEach((img, idx) => {
                const t = document.createElement('img');
                t.src = img;
                t.className = `h-12 w-12 md:h-20 md:w-20 object-cover rounded-xl cursor-pointer border-2 transition-all flex-shrink-0 ${idx === currentImgIdx ? 'border-brandGold scale-105' : 'border-transparent opacity-60 hover:opacity-100'}`;
                t.onclick = () => updateDetailImage(idx);
                thumbBar.appendChild(t);
            });
            // Auto scroll to active thumbnail
            const activeThumb = thumbBar.children[currentImgIdx];
            if (activeThumb) {
                activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        const swipeArea = document.getElementById('swipeArea');
        if (swipeArea) {
            swipeArea.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            swipeArea.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
        }

        function handleSwipe() {
            if (isZoomed) return; // Disable swipe when zoomed
            if (!currentProduct || currentProduct.images.length <= 1) return;
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) { // Threshold
                if (diff > 0) {
                    // Swipe left -> Next image
                    if (currentImgIdx < currentProduct.images.length - 1) {
                        updateDetailImage(currentImgIdx + 1);
                    }
                } else {
                    // Swipe right -> Prev image
                    if (currentImgIdx > 0) {
                        updateDetailImage(currentImgIdx - 1);
                    }
                }
            }
        }

        window.closeDetails = function() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
            // Reset zoom on close
            const img = document.getElementById('mainDetailImg');
            if(img) {
                isZoomed = false;
                img.style.transform = 'scale(1)';
            }
        }

        // Zoom Logic
        const mainImg = document.getElementById('mainDetailImg');
        const swipeContainer = document.getElementById('swipeArea');

        if (mainImg && swipeContainer) {
            mainImg.style.cursor = 'zoom-in';

            // Desktop: Mouse move to pan
            swipeContainer.addEventListener('mousemove', function(e) {
                if (isZoomed) {
                    const { left, top, width, height } = swipeContainer.getBoundingClientRect();
                    const x = ((e.clientX - left) / width) * 100;
                    const y = ((e.clientY - top) / height) * 100;
                    mainImg.style.transformOrigin = `${x}% ${y}%`;
                }
            });

            // Click to toggle zoom
            mainImg.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent modal close or other events
                if (isZoomed) {
                    isZoomed = false;
                    mainImg.style.transform = "scale(1)";
                    mainImg.style.cursor = "zoom-in";
                    setTimeout(() => {
                        if(!isZoomed) mainImg.style.transformOrigin = "center center"; 
                    }, 300);
                } else {
                    isZoomed = true;
                    mainImg.style.transform = "scale(2.5)";
                    mainImg.style.cursor = "zoom-out";
                    
                    // Initial zoom target based on click
                    const rect = swipeContainer.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 100;
                    const y = ((e.clientY - rect.top) / rect.height) * 100;
                    mainImg.style.transformOrigin = `${x}% ${y}%`;
                }
            });
        }

        window.toggleDarkMode = function() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            
            const isAutoEnabled = localStorage.getItem('autoThemeEnabled') !== 'false';
            if (isAutoEnabled) {
                localStorage.setItem('themeOverrideTime', Date.now());
                if (window._themeResetTimer) clearTimeout(window._themeResetTimer);
                window._themeResetTimer = setTimeout(() => {
                    localStorage.removeItem('darkMode');
                    localStorage.removeItem('themeOverrideTime');
                    applySmartTheme();
                }, 600000); 
            }

            // Expand the toggle briefly on desktop so the label appears for 3s
            const toggleEl = document.getElementById('darkToggle');
            if (!toggleEl) return;
            const isDesktop = window.matchMedia('(min-width: 769px)').matches;
            if (isDesktop) {
                if (window._darkToggleTimer) clearTimeout(window._darkToggleTimer);
                toggleEl.classList.add('expanded');
                window._darkToggleTimer = setTimeout(() => {
                    toggleEl.classList.remove('expanded');
                }, 3000);
            } else {
                toggleEl.classList.remove('expanded');
            }
        }

        // Ensure toggle is compact on initial load (remove expanded state)
        document.addEventListener('DOMContentLoaded', () => {
            const toggleEl = document.getElementById('darkToggle');
            if (toggleEl) toggleEl.classList.remove('expanded');
        });

        loadData();
    </script>
</body>
</html>
